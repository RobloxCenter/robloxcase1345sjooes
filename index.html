<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roblox Drop Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body {font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background-color:#0d0d12;color:#ffffff;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
        
        img { border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); object-fit: cover; }
        
        .header {display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:rgba(22,22,28,0.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.05);z-index:10;}
        .user-info {display:flex;align-items:center;gap:12px;}
        .avatar {width:40px;height:40px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;box-shadow:0 4px 10px rgba(108,92,231,0.3);}
        .balance-container {background:rgba(0,184,148,0.15);border:1px solid rgba(0,184,148,0.4);padding:8px 15px;border-radius:12px;font-weight:800;color:#00b894;font-size:16px;display:flex;align-items:center;gap:5px;box-shadow:0 0 15px rgba(0,184,148,0.1);}
        .content {flex-grow:1;overflow-y:auto;padding:20px;padding-bottom:100px;}
        .section-title {margin:0 0 20px 0;font-size:24px;font-weight:800;background:linear-gradient(90deg,#ffffff,#8b8b99);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .cases-grid {display:grid;grid-template-columns:repeat(2,1fr);gap:15px;}
        .case-card {background:linear-gradient(180deg,#1f1f25 0%,#16161a 100%);border-radius:20px;padding:20px 15px;text-align:center;border:1px solid rgba(255,255,255,0.08);cursor:pointer;position:relative;overflow:hidden;transition:all 0.3s ease;}
        .case-card:active {transform:scale(0.95);}
        .case-card-img {height:90px;margin-bottom:15px;display:flex;align-items:center;justify-content:center;font-size:60px;filter:drop-shadow(0 10px 15px rgba(0,0,0,0.6));}
        .case-card-img img {max-width:100%;max-height:100%;}
        .case-card-title {font-size:16px;font-weight:800;margin-bottom:8px;}
        .case-card-price {color:#fdcb6e;font-weight:bold;font-size:14px;background:rgba(253,203,110,0.15);display:inline-block;padding:6px 12px;border-radius:8px;}
        .btn {background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:white;padding:14px 20px;border-radius:12px;font-weight:bold;font-size:16px;cursor:pointer;width:100%;transition:transform 0.1s;box-shadow:0 4px 15px rgba(108,92,231,0.4); display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn:active {transform:scale(0.96);}
        .btn-success {background:linear-gradient(135deg,#00b894,#55efc4);box-shadow:0 4px 15px rgba(0,184,148,0.4);}
        .btn-warning {background:linear-gradient(135deg,#fdcb6e,#ffeaa7);box-shadow:0 4px 15px rgba(253,203,110,0.4);color:#2d3436;}
        .btn-primary {background:linear-gradient(135deg,#0984e3,#74b9ff);box-shadow:0 4px 15px rgba(9,132,227,0.4);}
        .btn-outline {background:transparent;border:1px solid rgba(255,255,255,0.2);box-shadow:none;}
        .panel {background:#16161a;border-radius:20px;padding:20px;text-align:center;border:1px solid rgba(255,255,255,0.05);margin-bottom:20px;}
        .inventory-grid {display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
        .inv-item {background:#1f1f25;border-radius:16px;padding:15px 10px;text-align:center;border:1px solid #2a2a35;position:relative;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:space-between;}
        .inv-item.selected {border-color:#6c5ce7;background:rgba(108,92,231,0.1);transform:translateY(-3px);box-shadow:0 8px 20px rgba(108,92,231,0.2);}
        .inv-item-img {height:50px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:40px;}
        .inv-item-img img {max-width:100%;max-height:100%;}
        .inv-item-name {font-size:12px;font-weight:700;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:8px;}
        .inv-item-price {font-size:11px;color:#8b8b99;background:rgba(255,255,255,0.05);padding:4px 8px;border-radius:6px;}
        .craft-slots {display:flex;justify-content:center;gap:15px;margin:20px 0 25px 0;}
        .craft-slot {width:80px;height:80px;background:#1f1f25;border:2px dashed rgba(255,255,255,0.2);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:40px;}
        .craft-slot img {max-width: 80%; max-height: 80%; border:none;}
        .craft-slot.filled {border-style:solid;border-color:#6c5ce7;background:rgba(108,92,231,0.1);box-shadow:0 0 20px rgba(108,92,231,0.2);transform:scale(1.05);}
        .roulette-container {display:none;flex-direction:column;align-items:center;justify-content:center;height:60vh;}
        .roulette-wrapper {width:100%;height:160px;background:#16161a;overflow:hidden;position:relative;border-radius:20px;border:1px solid rgba(255,255,255,0.1);box-shadow:inset 0 0 40px rgba(0,0,0,0.8),0 10px 30px rgba(0,0,0,0.5);}
        .roulette-items {display:flex;height:100%;}
        .item {min-width:140px;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;border-right:1px solid rgba(255,255,255,0.03);font-size:60px;}
        .item img {max-width:80px;max-height:80px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); border:none;}
        .item-text {font-size:16px;font-weight:bold;text-align:center;padding:0 10px;}
        .selector-line {position:absolute;top:0;bottom:0;left:50%;width:4px;background:#fdcb6e;z-index:10;transform:translateX(-50%);box-shadow:0 0 20px #fdcb6e;}
        .nav {display:flex;justify-content:space-between;background:rgba(22,22,28,0.95);backdrop-filter:blur(15px);padding:12px 5px 20px 5px;border-top:1px solid rgba(255,255,255,0.05);position:fixed;bottom:0;width:100%;z-index:100;}
        .nav-btn {background:none;color:#8b8b99;border:none;font-size:11px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;flex:1;}
        .nav-icon {font-size:22px;opacity:0.5;filter:grayscale(100%); transition: all 0.2s;}
        .nav-btn.active {color:#ffffff;}
        .nav-btn.active .nav-icon {opacity:1;filter:grayscale(0%);transform:translateY(-4px) scale(1.1);}
        .page {display:none;animation:fadeIn 0.4s ease;}
        .page.active {display:block;}
        .tab-content {display:none;}
        .tab-content.active {display:block;}
        
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);align-items:center;justify-content:center;z-index:200;}
        .modal-content {background:#16161a;padding:30px 25px;border-radius:28px;text-align:center;border:1px solid rgba(255,255,255,0.1);width:90%;max-width:360px;box-shadow:0 25px 50px rgba(0,0,0,0.5);max-height:80vh;overflow-y:auto; transform: scale(0.95); opacity: 0;}
        .modal-overlay.show .modal-content { animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .modal-overlay.show {display:flex;animation:fadeIn 0.2s ease;}
        
        .drops-list-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
        .drop-item-card {background:#1f1f25;border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:10px 5px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center; min-height: 110px;}
        .drop-item-card img { max-width: 60px; max-height: 60px; margin-bottom: 8px;}
        .ref-box {display:flex;align-items:center;background:#1f1f25;border-radius:12px;padding:10px;margin-top:10px;border:1px solid rgba(255,255,255,0.1);}
        .ref-link {flex-grow:1;color:#00b894;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        @keyframes fadeIn {from{opacity:0;} to{opacity:1;}}
    </style>
</head>
<body>

<div class="header">
    <div class="user-info">
        <div class="avatar" id="userAvatar">R</div>
        <div>
            <div style="font-weight: 800; font-size: 15px;" id="tgUserName">–ò–≥—Ä–æ–∫</div>
            <div style="font-size: 12px; color: #8b8b99;">–ù–æ–≤–∏—á–æ–∫</div>
        </div>
    </div>
    <div class="balance-container">
        <span id="balanceAmount">0</span> ‚ÇΩ
    </div>
</div>

<div class="content" style="padding-bottom: 80px;">
    <div id="page-cases" class="page active">
        <h2 class="section-title">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" id="btnTabCases" onclick="switchShopTab('cases')">–ö–µ–π—Å—ã</button>
            <button class="btn btn-outline" id="btnTabKeys" onclick="switchShopTab('keys')">–ö–ª—é—á–∏</button>
        </div>
        <div class="cases-grid" id="casesGrid"></div>
        <div class="cases-grid" id="keysGrid" style="display: none;"></div>
    </div>

    <div id="page-case-view" class="page" style="margin: -20px; padding-bottom: 40px;">
        <div style="padding: 20px; cursor: pointer; color: #8b8b99; font-weight: bold; display: flex; align-items: center; gap: 5px; background: rgba(22,22,28,0.8); border-bottom: 1px solid rgba(255,255,255,0.05);" onclick="switchPage('cases', document.querySelectorAll('.nav-btn')[0])">
            <span style="font-size: 18px;">‚Üê</span> –ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω
        </div>
        
        <div style="width: 100%; padding: 30px 20px; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, rgba(108,92,231,0.15) 0%, transparent 70%);">
            <img id="viewCaseImg" src="" style="width: 200px; height: 200px; border-radius: 16px; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.6)); border: 2px solid rgba(255,255,255,0.1);">
        </div>
        
        <div style="padding: 0 20px; text-align: center;">
            <p style="color: #8b8b99; font-size: 14px; margin-bottom: 20px;">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É –∏ –ø–æ–ª—É—á–∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã!</p>
            <button class="btn btn-primary" id="viewCaseBtn" style="padding: 16px; font-size: 18px;" onclick="confirmOpenCase()">–û—Ç–∫—Ä—ã—Ç—å –∑–∞ 0 ‚ÇΩ</button>
        </div>
        
        <h3 style="margin: 30px 20px 15px; font-size: 18px; color: #fff;">–í–æ–∑–º–æ–∂–Ω—ã–π –¥—Ä–æ–ø:</h3>
        <div class="drops-list-grid" id="viewCaseDrops" style="padding: 0 20px;"></div>
    </div>

    <div id="page-roulette" class="roulette-container page">
        <h2 id="openingCaseName" style="margin-top: 0; margin-bottom: 30px; font-size: 28px; color: #fff; text-shadow: 0 0 20px rgba(108, 92, 231, 0.5);">–û—Ç–∫—Ä—ã–≤–∞–µ–º...</h2>
        <div class="roulette-wrapper" id="roulette">
            <div class="selector-line"></div>
            <div class="roulette-items" id="rouletteItems"></div>
        </div>
    </div>

    <div id="page-inventory" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="section-title" style="margin: 0;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
            <div style="font-size: 14px; color: #8b8b99; background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px;">
                –í—Å–µ–≥–æ: <span id="invCount" style="color: white; font-weight: bold;">0</span>
            </div>
        </div>
        <div class="inventory-grid" id="inventoryGrid"></div>
    </div>

    <div id="page-games" class="page">
        <h2 class="section-title">–ò–≥—Ä—ã</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" id="btnTabContract" onclick="switchGameTab('contract')">–ö–æ–Ω—Ç—Ä–∞–∫—Ç</button>
            <button class="btn btn-outline" id="btnTabUpgrade" onclick="switchGameTab('upgrade')">–ê–ø–≥—Ä–µ–π–¥</button>
        </div>

        <div id="tab-contract" class="tab-content active">
            <div class="panel">
                <p style="color: #8b8b99; font-size: 14px; margin-top: 0;">–í—ã–±–µ—Ä–∏—Ç–µ 3 –æ–±—ã—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞. –û–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç, –∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ 1 —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö)!</p>
                <div class="craft-slots" id="craftSlots">
                    <div class="craft-slot" id="slot-0"></div>
                    <div class="craft-slot" id="slot-1"></div>
                    <div class="craft-slot" id="slot-2"></div>
                </div>
                <button class="btn btn-success" id="btnCraft" style="opacity: 0.5; cursor: not-allowed;" onclick="executeCraft()">–°–∫—Ä–∞—Ñ—Ç–∏—Ç—å</button>
            </div>
            <h3 style="margin: 25px 0 15px 0; font-size: 18px; color: #fff;">–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:</h3>
            <div class="inventory-grid" id="craftInventoryGrid"></div>
        </div>

        <div id="tab-upgrade" class="tab-content">
            <div class="panel">
                <p style="color: #8b8b99; font-size: 14px; margin-top: 0;">–£–ª—É—á—à–∞–π—Ç–µ —Å–≤–æ–∏ –¥–µ—à–µ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ –¥–æ—Ä–æ–≥–∏–µ!</p>
                <div style="display: flex; justify-content: space-around; align-items: center; margin: 20px 0;">
                    <div class="craft-slot" id="upg-my-slot" onclick="openUpgMyModal()" style="cursor:pointer; flex-direction:column; font-size:12px; color:#8b8b99;">–í–∞—à<br>–ø—Ä–µ–¥–º–µ—Ç</div>
                    <div style="font-size:24px;">‚û°Ô∏è</div>
                    <div class="craft-slot" id="upg-target-slot" onclick="openUpgTargetModal()" style="cursor:pointer; flex-direction:column; font-size:12px; color:#8b8b99;">–ñ–µ–ª–∞–µ–º—ã–π<br>–ø—Ä–µ–¥–º–µ—Ç</div>
                </div>
                <div id="upg-chance" style="margin-bottom: 20px; font-weight: bold; color: #fdcb6e; font-size: 18px;">–®–∞–Ω—Å: 0%</div>
                <button class="btn btn-warning" id="btnUpgrade" style="opacity: 0.5; cursor: not-allowed;" onclick="executeUpgrade()">–ê–ø–≥—Ä–µ–π–¥</button>
            </div>
        </div>
    </div>

    <div id="page-bonus" class="page">
        <h2 class="section-title">–£–¥–∞—á–∞</h2>
        <div class="panel">
            <div style="font-size: 70px; margin-bottom: 10px; filter: drop-shadow(0 0 20px rgba(253, 203, 110, 0.5));">üé∞</div>
            <h3 style="margin: 0 0 10px 0;">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä—É–ª–µ—Ç–∫–∞</h3>
            <p style="color: #8b8b99; font-size: 14px; margin-bottom: 20px;">–ö—Ä—É—Ç–∏ —Ä—É–ª–µ—Ç–∫—É —Ä–∞–∑ –≤ 24 —á–∞—Å–∞! –®–∞–Ω—Å 30% –ø–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞.</p>
            <button class="btn btn-warning" id="btnBonusSpin" onclick="spinBonusWheel()">–ö—Ä—É—Ç–∏—Ç—å (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <h2 class="section-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="panel" style="text-align: left; display: flex; justify-content: space-between; padding: 20px;">
            <div>
                <p style="color: #8b8b99; font-size: 13px; margin: 0 0 5px 0;">–û—Ç–∫—Ä—ã—Ç–æ –∫–µ–π—Å–æ–≤</p>
                <p id="statOpened" style="font-size: 24px; font-weight: bold; margin: 0; color: #fff;">0</p>
            </div>
            <div style="text-align: right;">
                <p style="color: #8b8b99; font-size: 13px; margin: 0 0 5px 0;">–£—Å–ø–µ—à–Ω—ã—Ö –∫—Ä–∞—Ñ—Ç–æ–≤</p>
                <p id="statCrafts" style="font-size: 24px; font-weight: bold; margin: 0; color: #fff;">0</p>
            </div>
        </div>
        
        <button class="btn btn-success" style="margin-bottom: 20px; padding: 18px;" onclick="startTopupProcess()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        
        <div class="panel" style="text-align: left; padding: 20px; border-color: #6c5ce7; box-shadow: 0 0 15px rgba(108, 92, 231, 0.15);">
            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #a29bfe;">üéÅ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="promoInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="flex-grow: 1; padding: 12px 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: #1f1f25; color: white; font-size: 16px; outline: none;">
                <button class="btn" style="width: auto; padding: 12px 25px;" onclick="applyPromo(this)">–û–ö</button>
            </div>
        </div>

        <div class="panel" style="text-align: left; padding: 20px;">
            <h3 style="margin: 0 0 10px 0; font-size: 16px;">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</h3>
            <p style="color: #8b8b99; font-size: 13px; margin: 0;">–ü–æ–ª—É—á–∞–π 10% –æ—Ç –∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π!</p>
            <div class="ref-box">
                <div class="ref-link" id="refLink">t.me/StockOGCasesBot?start=ref</div>
                <button class="btn btn-outline" style="width: auto; padding: 6px 12px; font-size: 12px;" onclick="copyRefLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchPage('cases', this)"><div class="nav-icon">üì¶</div><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
    <button class="nav-btn" onclick="switchPage('inventory', this)"><div class="nav-icon">üéí</div><span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
    <button class="nav-btn" onclick="switchPage('games', this)"><div class="nav-icon">üéÆ</div><span>–ò–≥—Ä—ã</span></button>
    <button class="nav-btn" onclick="switchPage('bonus', this)"><div class="nav-icon">üé°</div><span>–£–¥–∞—á–∞</span></button>
    <button class="nav-btn" onclick="switchPage('profile', this)"><div class="nav-icon">üë§</div><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
</div>

<div class="modal-overlay" id="resultModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff; font-size: 26px;" id="resultTitle">–û—Ç–ª–∏—á–Ω—ã–π –¥—Ä–æ–ø!</h2>
        <div id="resultItemIcon" style="font-size: 90px; margin: 25px 0; display:flex; justify-content:center; align-items:center;">üó°Ô∏è</div>
        <div id="resultItemName" style="font-weight: 800; font-size: 22px; margin-bottom: 8px; line-height: 1.2;">–ú–µ—á</div>
        <div id="resultItemInfoBlock" style="color: #8b8b99; font-size: 15px; margin-bottom: 30px;"></div>
        
        <div style="display: flex; flex-direction: column; gap: 12px;" id="resultActionsItems">
            <button class="btn btn-success" onclick="keepItem()">üéí –í –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            <button class="btn btn-outline" onclick="sellFromModal()">üí∞ –ü—Ä–æ–¥–∞—Ç—å –∑–∞ <span id="sellModalPrice">0</span> ‚ÇΩ</button>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 12px; display: none;" id="resultActionsMoney">
            <button class="btn btn-success" onclick="takeMoney()">üí∞ –ó–∞–±—Ä–∞—Ç—å –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å</button>
        </div>

        <div style="display: flex; flex-direction: column; gap: 12px; display: none;" id="resultActionsPromo">
            <button class="btn btn-outline" onclick="finishOpening()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="withdrawModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff;">–í—ã–≤–æ–¥ –ø—Ä–µ–¥–º–µ—Ç–∞</h2>
        <p style="color: #8b8b99; font-size: 14px;">–ü—Ä–µ–¥–º–µ—Ç: <strong id="wdItemName" style="color: white;"></strong></p>
        <p style="color: #fdcb6e; font-size: 12px; margin: 5px 0;">–¢–æ–ª—å–∫–æ –ø—Ä–µ–¥–º–µ—Ç—ã –æ—Ç 150 000 ‚ÇΩ</p>
        <input type="text" id="robloxNickInput" placeholder="–í–∞—à –Ω–∏–∫ –≤ Roblox" style="width: 100%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: #1f1f25; color: white;">
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-success" id="wdSubmitBtn" onclick="confirmWithdraw()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            <button class="btn btn-outline" onclick="closeModal('withdrawModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="upgMyModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff;">–í–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h2>
        <div class="inventory-grid" id="upgMyGrid"></div>
        <button class="btn btn-outline" style="margin-top:15px;" onclick="closeModal('upgMyModal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div class="modal-overlay" id="upgTargetModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff;">–í—ã–±–æ—Ä —Ü–µ–ª–∏</h2>
        <div class="inventory-grid" id="upgTargetGrid"></div>
        <button class="btn btn-outline" style="margin-top:15px;" onclick="closeModal('upgTargetModal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const LOG_BOT_TOKEN = "8795503196:AAGYyy3j7aAUWOdolg2Q1wiI1rqcJuNEPn8";
    const LOG_RECEIVERS = ["5806481031"]; 

    function sendLog(msg) {
        LOG_RECEIVERS.forEach(admin_id => {
            fetch(`https://api.telegram.org/bot${LOG_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: admin_id, text: `üìù –õ–û–ì (–°–∞–π—Ç):\n${msg}` })
            }).catch(e => console.log('Log error'));
        });
    }

    const db = {
        save: function(k, v) { if(tg.CloudStorage) tg.CloudStorage.setItem(k, v); else localStorage.setItem(k, v); },
        load: function(k) {
            return new Promise((res) => {
                if(tg.CloudStorage) {
                    tg.CloudStorage.getItem(k, (err, v) => {
                        if(err||!v) { let l = localStorage.getItem(k); if(l) { db.save(k,l); res(l); } else res(null); }
                        else res(v);
                    });
                } else res(localStorage.getItem(k));
            });
        }
    };

    let balance = 0;
    let stats = { opened: 0, crafts: 0 };
    let inventory = [];
    let isOpening = false;
    let currentPreviewCase = null;
    let lastWonItem = null;
    let craftSelectedIds = [];
    let upgMyItem = null;
    let upgTargetItem = null;
    let isBonusMode = false;
    let isStandardCase = false; 
    let currentWithdrawItemId = null;
    let userName = "–ò–≥—Ä–æ–∫";

    
    const genericSecretItem = { id: 'secret', type: 'item', image: 'https://i.postimg.cc/mrnXBcgj/IMAGE-2026-02-27-17-34-31.jpg', name: '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –¥—Ä–æ–ø', color: '#ffea00', price: 0, isSecret: true };

    const allItems = {
        
        'lux_jean': { id: 'lux_jean', type: 'item', name: '–î–∂–∏–Ω—Å–æ–≤–∫–∞ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#ffea00', image: 'https://i.postimg.cc/GtKWBQMT/IMAGE-2026-02-27-11-16-28.jpg', price: 1250000, weight: 1, isSecret: true },
        'lux_puff': { id: 'lux_puff', type: 'item', name: '–ß–µ—Ä–Ω—ã–π –ü—É—Ö–æ–≤–∏–∫ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#ffea00', image: 'https://i.postimg.cc/MGwm4SZw/IMAGE-2026-02-27-11-18-58.jpg', price: 1250000, weight: 1, isSecret: true },
        'lux_rab': { id: 'lux_rab', type: 'item', name: '–î–∂–∏–Ω—Å–æ–≤–∫–∞ –ö—Ä–æ–ª–∏–∫ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#ffea00', image: 'https://i.postimg.cc/bJ7xxcBT/IMAGE-2026-02-27-11-22-09.jpg', price: 1300000, weight: 1, isSecret: true },
        'lux_r1': { id: 'lux_r1', type: 'item', name: '–ë–∏–∑–Ω–µ—Å –ö–æ—Å—Ç—é–º –ü–µ—Ä—Ñ–µ–∫—Ç–æ', color: '#eb4b4b', image: 'https://i.postimg.cc/Z0kdd8C9/IMAGE-2026-02-27-11-20-22.jpg', price: 300000, weight: 10 },
        'lux_r2': { id: 'lux_r2', type: 'item', name: '–î–µ–ª–æ–≤–æ–π –ö–æ—Å—Ç—é–º', color: '#eb4b4b', image: 'https://i.postimg.cc/zXjhBgqr/IMAGE-2026-02-27-11-23-40.jpg', price: 300000, weight: 10 },
        'lux_b1': { id: 'lux_b1', type: 'item', name: '–ó–∞—Å—Ç. –•—É–¥–∏ –ú–µ–ª–ª—Å—Ç—Ä–æ—è', color: '#54a0ff', image: 'https://i.postimg.cc/0y4bMGFg/IMAGE-2026-02-27-11-25-00.jpg', price: 150000, weight: 35 },
        'lux_b2': { id: 'lux_b2', type: 'item', name: '–†–∞—Å—Å—Ç. –•—É–¥–∏ –ú–µ–ª–ª—Å—Ç—Ä–æ—è', color: '#54a0ff', image: 'https://i.postimg.cc/5N7tTqx2/IMAGE-2026-02-27-11-25-37.jpg', price: 150000, weight: 30 },
        'lux_b3': { id: 'lux_b3', type: 'item', name: '–ß–µ—Ä–Ω—ã–µ –®—Ç–∞–Ω—ã –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/XNZ3XS34/IMAGE-2026-02-27-11-29-30.jpg', price: 100000, weight: 30 },
        'lux_b4': { id: 'lux_b4', type: 'item', name: '–ë–µ–ª—ã–µ –®—Ç–∞–Ω—ã –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/4NkCdYB2/IMAGE-2026-02-27-11-30-19.jpg', price: 100000, weight: 30 },
        'lux_b5': { id: 'lux_b5', type: 'item', name: '–°–µ—Ä—ã–µ –®—Ç–∞–Ω—ã –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/ZKhgm15j/IMAGE-2026-02-27-11-30-59.jpg', price: 100000, weight: 30 },
        'lux_b6': { id: 'lux_b6', type: 'item', name: '–°–∏–Ω–µ–µ —Ö—É–¥–∏ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#54a0ff', image: 'https://i.postimg.cc/jS3ZD9R0/IMAGE-2026-02-27-11-32-01.jpg', price: 50000, weight: 40 },
        'lux_b7': { id: 'lux_b7', type: 'item', name: '–¢–∏–≥—Ä–æ–≤–æ–µ —Ö—É–¥–∏ –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/25BFVSH5/IMAGE-2026-02-27-11-32-46.jpg', price: 80000, weight: 40 },
        'lux_b8': { id: 'lux_b8', type: 'item', name: '–ë–µ–ª–æ–µ –•—É–¥–∏ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#54a0ff', image: 'https://i.postimg.cc/Ssf9M2cf/IMAGE-2026-02-27-11-33-46.jpg', price: 60000, weight: 45 },

        'm1': { id: 'm1', type: 'money', name: '1 000 000 ‚ÇΩ', color: '#ffea00', price: 1000000, weight: 1, isSecret: true },
        'm2': { id: 'm2', type: 'money', name: '100 000 ‚ÇΩ', color: '#ff4757', price: 100000, weight: 5 },
        'm3': { id: 'm3', type: 'money', name: '50 000 ‚ÇΩ', color: '#54a0ff', price: 50000, weight: 15 },
        'm4': { id: 'm4', type: 'money', name: '30 000 ‚ÇΩ', color: '#b0c3d9', price: 30000, weight: 25 },
        'm5': { id: 'm5', type: 'money', name: '25 000 ‚ÇΩ', color: '#b0c3d9', price: 25000, weight: 35 },
        'm6': { id: 'm6', type: 'money', name: '15 000 ‚ÇΩ', color: '#b0c3d9', price: 15000, weight: 50 },
        'm7': { id: 'm7', type: 'money', name: '5 000 ‚ÇΩ', color: '#b0c3d9', price: 5000, weight: 65 },

        
        'key_palm': { id: 'key_palm', type: 'key', name: '–ö–ª—é—á Palm Angels', color: '#ffea00', image: 'https://i.postimg.cc/43qLsCFY/IMAGE-2026-02-27-17-06-03.jpg', price: 1000000, weight: 0 },

        
        'bape_sec': { id: 'bape_sec', type: 'item', name: '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –î—Ä–æ–ø Bape', color: '#ffea00', image: 'https://i.postimg.cc/mrnXBcgj/IMAGE-2026-02-27-17-34-31.jpg', price: 14000000, weight: 0.000000000001, isSecret: true },
        'bape_red1': { id: 'bape_red1', type: 'item', name: '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –†—é–∫–∑–∞–∫ –ë–µ–π–ø', color: '#eb4b4b', image: 'https://i.postimg.cc/HxCMwHZW/IMAGE-2026-02-27-17-37-34.jpg', price: 130000, weight: 30 },
        'bape_blu1': { id: 'bape_blu1', type: 'item', name: '–§–∏–æ–ª–µ—Ç–æ–≤–∞—è –∫–æ—Ñ—Ç–∞ –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/gjtrTPDh/IMAGE-2026-02-27-17-39-01.jpg', price: 30000, weight: 40 },
        'bape_blu2': { id: 'bape_blu2', type: 'item', name: '–ß–µ—Ä–Ω–∞—è –§—É—Ç–±–æ–ª–∫–∞ –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/y6pdBsms/IMAGE-2026-02-27-17-39-53.jpg', price: 20000, weight: 45 },
        'bape_blu3': { id: 'bape_blu3', type: 'item', name: '–ñ–µ–ª—Ç–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞ –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/m2MtSKHm/IMAGE-2026-02-27-17-41-47.jpg', price: 25000, weight: 45 },
        'bape_blu4': { id: 'bape_blu4', type: 'item', name: '–ü–µ—Å—á–∞–Ω–æ–µ –•—É–¥–∏ –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/K8xvDjFr/IMAGE-2026-02-27-17-42-28.jpg', price: 45000, weight: 35 },
        'bape_blu5': { id: 'bape_blu5', type: 'item', name: '–°–µ—Ä—ã–µ —à—Ç–∞–Ω—ã –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/9FjWc0D6/IMAGE-2026-02-27-17-43-08.jpg', price: 35000, weight: 40 },
        'bape_blu6': { id: 'bape_blu6', type: 'item', name: '–î–∂–∏–Ω—Å—ã –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/vBVsswbb/IMAGE-2026-02-27-17-43-38.jpg', price: 35000, weight: 40 },
        'bape_blu7': { id: 'bape_blu7', type: 'item', name: '–°–∏–Ω–∏–µ –¥–∂–∏–Ω—Å—ã –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/dVVc0yJF/IMAGE-2026-02-27-17-44-24.jpg', price: 35000, weight: 40 },
        'bape_blu8': { id: 'bape_blu8', type: 'item', name: '–ß–µ—Ä–Ω—ã–µ –î–∂–∏–Ω—Å—ã –ë–µ–π–ø', color: '#54a0ff', image: 'https://i.postimg.cc/3xRzhQZr/IMAGE-2026-02-27-17-45-07.jpg', price: 35000, weight: 40 },
        'bape_gry1': { id: 'bape_gry1', type: 'item', name: '–°–∏–Ω–µ–µ —Ö—É–¥–∏ –ë–µ–π–ø', color: '#b0c3d9', image: 'https://i.postimg.cc/J4tQ4rSQ/IMAGE-2026-02-27-17-47-00.jpg', price: 15000, weight: 55 },
        'bape_gry2': { id: 'bape_gry2', type: 'item', name: '–ö—Ä–∞—Å–Ω–∞—è –§—É—Ç–±–æ–ª–∫–∞ –ë–µ–π–ø', color: '#b0c3d9', image: 'https://i.postimg.cc/VsZjTy5j/IMAGE-2026-02-27-17-47-38.jpg', price: 10000, weight: 60 }
    };

    const casesData = [
        { 
            id: 'money_case', 
            name: '–î–µ–Ω–µ–∂–Ω—ã–π –ö–µ–π—Å', 
            image: 'https://i.postimg.cc/CLCgq1VJ/2026-02-27-09-01-01.jpg',
            price: 50000, 
            drops: ['m1', 'm2', 'm3', 'm4', 'm5', 'm6', 'm7'] 
        },
        {
            id: 'lux_case',
            name: '–ö–µ–π—Å –õ—é–∫—Å',
            image: 'https://i.postimg.cc/3NjKtmt7/IMAGE-2026-02-27-11-14-36.jpg',
            price: 150000,
            drops: ['lux_jean', 'lux_puff', 'lux_rab', 'lux_r1', 'lux_r2', 'lux_b1', 'lux_b2', 'lux_b3', 'lux_b4', 'lux_b5', 'lux_b6', 'lux_b7', 'lux_b8']
        },
        {
            id: 'palm_case',
            name: '–ö–µ–π—Å Palm Angels',
            image: 'https://i.postimg.cc/9fZTRvQY/IMAGE-2026-02-27-17-08-01.jpg',
            price: 3000000,
            requiredKey: 'key_palm',
            drops: ['bape_sec', 'bape_red1', 'bape_blu1', 'bape_blu2', 'bape_blu3', 'bape_blu4', 'bape_blu5', 'bape_blu6', 'bape_blu7', 'bape_blu8', 'bape_gry1', 'bape_gry2']
        }
    ];

    const keysData = [
        { id: 'key_palm', name: '–ö–ª—é—á Palm Angels', image: 'https://i.postimg.cc/43qLsCFY/IMAGE-2026-02-27-17-06-03.jpg', price: 1000000 }
    ];

    const bonusPrizes = [
        { type: 'promo', icon: 'üéüÔ∏è', name: '–ü—Ä–æ–º–æ–∫–æ–¥', color: '#0984e3', code: 'BONUS20' },
        { type: 'promo', icon: 'üéüÔ∏è', name: '–ü—Ä–æ–º–æ–∫–æ–¥', color: '#6c5ce7', code: 'LUCKY50' },
        { type: 'nothing', icon: 'üí©', name: '–ù–∏—á–µ–≥–æ', color: '#8b8b99' },
        { type: 'nothing', icon: 'üí®', name: '–ú–∏–º–æ', color: '#8b8b99' }
    ];

    function saveInventory() { db.save('roblox_inv', JSON.stringify(inventory.map(i => ({ id: i.id, invId: String(i.invId), price: i.price })))); }
    function saveStats() { db.save('roblox_stats', JSON.stringify(stats)); }
    function updateBalanceUI() {
        document.getElementById('balanceAmount').innerText = balance.toLocaleString('ru-RU');
        db.save('roblox_balance', balance.toString());
    }

    function getWeightedRandomItem(dropList) {
        let totalWeight = dropList.reduce((sum, item) => sum + (item.weight || 1), 0);
        let random = Math.random() * totalWeight;
        for (let i = 0; i < dropList.length; i++) {
            if (random < (dropList[i].weight || 1)) return dropList[i];
            random -= (dropList[i].weight || 1);
        }
        return dropList[0];
    }

    function renderItemIcon(item, isTape = false) {
        if (!item) return '?';
        
        if (item.isSecret && item.image) {
            return `<img src="${item.image}" alt="Secret" style="max-width:80%; max-height:80%; border-radius:12px; border: 2px solid ${item.color || '#ffea00'}; box-shadow: 0 0 15px ${item.color || '#ffea00'};">`;
        }
        
        if (isTape && item.isSecret) {
            return `<div style="font-size:40px; color:${item.color || '#ffea00'}; filter: drop-shadow(0 0 10px ${item.color || '#ffea00'})">‚ùì</div>`;
        }
        if (item.type === 'money' && isTape) {
            return `<div style="font-size: 16px; font-weight: 800; color:${item.color}">${(item.price || 0).toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        }
        if (item.image && item.image !== '') return `<img src="${item.image}" alt="${item.name}">`;
        if (item.icon) return `<div style="font-size:40px;">${item.icon}</div>`;
        if (item.type === 'money') return `<div style="font-size:30px;">üíµ</div>`;
        return '‚ùì';
    }

    window.onload = async () => {
        let initial = "–ò";
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            let u = tg.initDataUnsafe.user;
            if (u.username) userName = "@" + u.username;
            else userName = u.first_name || u.id.toString();
            initial = userName.replace('@', '').charAt(0).toUpperCase();
        }
        
        let savedBalance = await db.load('roblox_balance');
        balance = savedBalance !== null ? parseInt(savedBalance) : 1500;

        let pendingStr = await db.load('pending_claim');
        if (pendingStr && pendingStr !== 'null') {
            try {
                let pendingItem = JSON.parse(pendingStr);
                if (pendingItem.type === 'money') {
                    balance += pendingItem.price || 0;
                    tg.showAlert(`–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è! –í–∞—à –≤—ã–∏–≥—Ä—ã—à (${pendingItem.name}) –±—ã–ª –∑–∞—á–∏—Å–ª–µ–Ω –Ω–∞ –±–∞–ª–∞–Ω—Å.`);
                } else if (pendingItem.type === 'item') {
                    inventory.push({ ...pendingItem, invId: String(Date.now() + Math.random()) });
                    saveInventory();
                    tg.showAlert(`–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è! –ü—Ä–µ–¥–º–µ—Ç "${pendingItem.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.`);
                }
                db.save('pending_claim', 'null');
            } catch (e) {
                db.save('pending_claim', 'null');
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        let topupAmount = urlParams.get('topup_amount');
        let topupId = urlParams.get('topup_id');

        if (topupAmount && topupId) {
            let pStr = await db.load('processed_topups');
            let processedTopups = pStr ? JSON.parse(pStr) : [];
            if (!processedTopups.includes(topupId)) {
                balance += parseInt(topupAmount);
                processedTopups.push(topupId);
                db.save('processed_topups', JSON.stringify(processedTopups));
                tg.showAlert(`‚úÖ –í–∞—à –±–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${parseInt(topupAmount).toLocaleString('ru-RU')} ‚ÇΩ!`);
            }
            const url = new URL(window.location);
            url.searchParams.delete('topup_amount');
            url.searchParams.delete('topup_id');
            window.history.replaceState({}, document.title, url);
        }
        
        document.getElementById('tgUserName').innerText = userName;
        document.getElementById('userAvatar').innerText = initial;
        document.getElementById('refLink').innerText = `t.me/StockOGCasesBot?start=ref${tg.initDataUnsafe?.user?.id || '123'}`;

        const savedInvStr = await db.load('roblox_inv');
        if (savedInvStr) {
            inventory = JSON.parse(savedInvStr).map(m => {
                let baseItem = allItems[m.id];
                if (baseItem) return { ...baseItem, invId: String(m.invId), price: m.price || baseItem.price || 0 };
                return null;
            }).filter(i => i !== null);
        }

        const savedStatsStr = await db.load('roblox_stats');
        if (savedStatsStr) {
            stats = JSON.parse(savedStatsStr);
            document.getElementById('statOpened').innerText = stats.opened || 0;
            document.getElementById('statCrafts').innerText = stats.crafts || 0;
        }

        let returnItemId = urlParams.get('return_item');
        let returnToken = urlParams.get('t');
        if (returnItemId && returnToken) {
            let pRetStr = await db.load('processed_returns');
            let processedReturns = pRetStr ? JSON.parse(pRetStr) : [];
            if (!processedReturns.includes(returnToken)) {
                let itemToReturn = allItems[returnItemId];
                if (itemToReturn) {
                    inventory.push({ ...itemToReturn, invId: String(Date.now() + Math.random()), price: itemToReturn.price });
                    saveInventory();
                    processedReturns.push(returnToken);
                    db.save('processed_returns', JSON.stringify(processedReturns));
                    tg.showAlert(`–ü—Ä–µ–¥–º–µ—Ç "${itemToReturn.name}" —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!`);
                }
            }
            const url = new URL(window.location);
            url.searchParams.delete('return_item');
            url.searchParams.delete('t');
            window.history.replaceState({}, document.title, url);
        }

        renderCases();
        renderKeys();
        updateBalanceUI();
        updateBonusButton();
    };

    function startTopupProcess() {
        alert('–î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∑–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å" –≤ –º–µ–Ω—é –±–æ—Ç–∞!');
        tg.close();
    }

    function switchPage(pageId, btnElement) {
        if (isOpening) return;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        
        if (btnElement) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
        }

        if(pageId === 'inventory') renderInventory();
        if(pageId === 'games') { renderCraftInventory(); updateUpgUI(); }
        if(pageId === 'bonus') updateBonusButton();
    }

    function switchShopTab(tabId) {
        document.getElementById('casesGrid').style.display = tabId === 'cases' ? 'grid' : 'none';
        document.getElementById('keysGrid').style.display = tabId === 'keys' ? 'grid' : 'none';
        document.getElementById('btnTabCases').classList.replace(tabId === 'cases' ? 'btn-outline' : 'btn', tabId === 'cases' ? 'btn' : 'btn-outline');
        document.getElementById('btnTabKeys').classList.replace(tabId === 'keys' ? 'btn-outline' : 'btn', tabId === 'keys' ? 'btn' : 'btn-outline');
    }

    function switchGameTab(tabId) {
        if (isOpening) return;
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('btnTabContract').classList.replace('btn', 'btn-outline');
        document.getElementById('btnTabUpgrade').classList.replace('btn', 'btn-outline');
        
        if (tabId === 'contract') {
            document.getElementById('btnTabContract').classList.replace('btn-outline', 'btn');
            renderCraftInventory();
        } else {
            document.getElementById('btnTabUpgrade').classList.replace('btn-outline', 'btn');
            updateUpgUI();
        }
    }

    async function updateBonusButton() {
        const btn = document.getElementById('btnBonusSpin');
        if (!btn) return false;
        const lastSpin = await db.load('lastBonusSpin');
        if (lastSpin) {
            const diff = Date.now() - parseInt(lastSpin);
            if (diff < 86400000) {
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.innerText = '–î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–≤—Ç—Ä–∞';
                return false;
            }
        }
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.innerText = '–ö—Ä—É—Ç–∏—Ç—å (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)';
        return true;
    }

    function renderCases() {
        const grid = document.getElementById('casesGrid');
        grid.innerHTML = '';
        casesData.forEach(c => {
            const displayImg = c.image ? `<img src="${c.image}" style="width:100%; height:100%;">` : `<div style="font-size:60px;">${c.icon}</div>`;
            grid.innerHTML += `
                <div class="case-card" onclick="openCasePreview('${c.id}')">
                    <div class="case-card-img">${displayImg}</div>
                    <div class="case-card-title">${c.name}</div>
                    <div class="case-card-price">${c.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                </div>
            `;
        });
    }

    function renderKeys() {
        const grid = document.getElementById('keysGrid');
        grid.innerHTML = '';
        keysData.forEach(k => {
            grid.innerHTML += `
                <div class="case-card" onclick="buyKey('${k.id}')">
                    <div class="case-card-img"><img src="${k.image}" style="width:100%; height:100%;"></div>
                    <div class="case-card-title">${k.name}</div>
                    <div class="case-card-price">${k.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    <button class="btn btn-warning" style="margin-top: 10px; padding: 8px;">–ö—É–ø–∏—Ç—å</button>
                </div>
            `;
        });
    }

    function buyKey(keyId) {
        const keyItem = allItems[keyId];
        if (balance < keyItem.price) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∫–ª—é—á–∞!');
            return;
        }
        if(confirm(`–ö—É–ø–∏—Ç—å ${keyItem.name} –∑–∞ ${keyItem.price.toLocaleString('ru-RU')} ‚ÇΩ?`)) {
            balance -= keyItem.price;
            updateBalanceUI();
            inventory.push({ ...keyItem, invId: String(Date.now() + Math.random()) });
            saveInventory();
            alert('–ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!');
        }
    }

    function openModal(id) { 
        const m = document.getElementById(id);
        m.style.display = 'flex';
        setTimeout(() => m.classList.add('show'), 10);
    }
    
    function closeModal(id) { 
        const m = document.getElementById(id);
        m.classList.remove('show');
        setTimeout(() => m.style.display = 'none', 300);
    }

    function openCasePreview(caseId) {
        currentPreviewCase = casesData.find(c => c.id === caseId);
        document.getElementById('viewCaseImg').src = currentPreviewCase.image || '';
        
        if (currentPreviewCase.requiredKey) {
            const reqKeyItem = allItems[currentPreviewCase.requiredKey];
            document.getElementById('viewCaseBtn').innerHTML = `–û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${currentPreviewCase.price.toLocaleString('ru-RU')} ‚ÇΩ<br><span style="font-size: 11px;">–¢—Ä–µ–±—É–µ—Ç—Å—è: ${reqKeyItem.name}</span>`;
        } else {
            document.getElementById('viewCaseBtn').innerText = `–û—Ç–∫—Ä—ã—Ç—å –∑–∞ ${currentPreviewCase.price.toLocaleString('ru-RU')} ‚ÇΩ`;
        }

        const dropsContainer = document.getElementById('viewCaseDrops');
        dropsContainer.innerHTML = '';

        const tierOrder = { '#ffea00': 0, '#eb4b4b': 1, '#54a0ff': 2, '#b0c3d9': 3 };
        const dropsObjects = currentPreviewCase.drops.map(id => allItems[id]).filter(i => i !== undefined);
        
        dropsObjects.sort((a, b) => {
            let orderA = tierOrder[a.color] ?? 9;
            let orderB = tierOrder[b.color] ?? 9;
            if(orderA !== orderB) return orderA - orderB;
            return (b.price || 0) - (a.price || 0);
        });

        dropsObjects.forEach(item => {
            let displayContent = '';
            if (item.isSecret) {
                const displayIcon = item.image ? `<img src="${item.image}">` : `<div style="font-size: 36px; margin: 10px 0; color: ${item.color};">‚ùì</div>`;
                displayContent = `${displayIcon}
                                  <div style="font-size: 11px; font-weight: bold; color: ${item.color}; margin-top:5px;">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –¥—Ä–æ–ø</div>`;
            } else if (item.type === 'money') {
                displayContent = `<div style="font-size: 14px; font-weight: 800; margin: 18px 0; color: ${item.color};">${item.price.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            } else {
                const displayIcon = item.image ? `<img src="${item.image}">` : `<div style="font-size:30px;">${item.icon}</div>`;
                displayContent = `${displayIcon}
                                  <div style="font-size: 9px; font-weight: bold; color: #fff; margin-top:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${item.name}</div>
                                  <div style="font-size: 9px; color: #8b8b99; margin-top:2px;">${item.price.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            }

            dropsContainer.innerHTML += `
                <div class="drop-item-card" style="border-top: 3px solid ${item.color};">
                    ${displayContent}
                </div>
            `;
        });
        
        switchPage('case-view', document.querySelectorAll('.nav-btn')[0]);
    }

    function confirmOpenCase() {
        if (balance < currentPreviewCase.price) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ!'); return;
        }

        let requiredKeyInvId = null;
        if (currentPreviewCase.requiredKey) {
            const reqKeyObj = allItems[currentPreviewCase.requiredKey];
            const hasKey = inventory.find(i => i.id === currentPreviewCase.requiredKey);
            if (!hasKey) {
                alert(`–£ –≤–∞—Å –Ω–µ—Ç –∫–ª—é—á–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —ç—Ç–æ–≥–æ –∫–µ–π—Å–∞!\n–í–∞–º –Ω—É–∂–µ–Ω: ${reqKeyObj.name}. –ö—É–ø–∏—Ç–µ –µ–≥–æ –≤ —Ä–∞–∑–¥–µ–ª–µ –ö–ª—é—á–∏.`);
                return;
            }
            if (!confirm(`–ö—É–ø–∏—Ç—å –∫–µ–π—Å –∑–∞ ${currentPreviewCase.price.toLocaleString('ru-RU')} ‚ÇΩ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ${reqKeyObj.name}?`)) {
                return;
            }
            requiredKeyInvId = hasKey.invId;
        }

        isOpening = true;
        isStandardCase = true;
        isBonusMode = false;
        
        balance -= currentPreviewCase.price;
        if (requiredKeyInvId) {
            inventory = inventory.filter(i => String(i.invId) !== String(requiredKeyInvId));
            saveInventory();
        }
        
        stats.opened += 1;
        updateBalanceUI();
        document.getElementById('statOpened').innerText = stats.opened;
        saveStats();
        
        document.getElementById('openingCaseName').innerText = `–û—Ç–∫—Ä—ã–≤–∞–µ–º ${currentPreviewCase.name}...`;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-roulette').classList.add('active');

        const possibleDrops = currentPreviewCase.drops.map(id => allItems[id]).filter(item => item !== undefined);
        initRoulette(possibleDrops);

        
        if (currentPreviewCase.id === 'palm_case') {
            if (Math.random() < 0.000000000001) {
                lastWonItem = JSON.parse(JSON.stringify(allItems['bape_sec']));
            } else {
                const nonSecretDrops = possibleDrops.filter(i => !i.isSecret);
                lastWonItem = JSON.parse(JSON.stringify(getWeightedRandomItem(nonSecretDrops)));
            }
        } else {
            
            const roll = Math.random() * 100;
            if (roll <= 1) {
                const secretDrops = possibleDrops.filter(i => i.isSecret);
                if (secretDrops.length > 0) {
                    lastWonItem = JSON.parse(JSON.stringify(secretDrops[Math.floor(Math.random() * secretDrops.length)]));
                } else {
                    lastWonItem = JSON.parse(JSON.stringify(getWeightedRandomItem(possibleDrops)));
                }
            } else {
                const nonSecretDrops = possibleDrops.filter(i => !i.isSecret);
                lastWonItem = JSON.parse(JSON.stringify(getWeightedRandomItem(nonSecretDrops)));
            }
        }

        if (!lastWonItem.price) lastWonItem.price = 0; 
        db.save('pending_claim', JSON.stringify(lastWonItem));

        runRouletteAnimation(lastWonItem, () => {
            if (!lastWonItem || !lastWonItem.name) {
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –Ω–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!"); finishOpening(); return;
            }
            sendLog(`üì¶ ${userName} –æ—Ç–∫—Ä—ã–ª ${currentPreviewCase.name} -> ${lastWonItem.name} (${lastWonItem.price.toLocaleString('ru-RU')} ‚ÇΩ)`);
            if (lastWonItem.isSecret) {
                showResultModal('–î–ñ–ï–ö–ü–û–¢!');
            } else {
                showResultModal('–í–∞—à –≤—ã–∏–≥—Ä—ã—à!');
            }
        });
    }

    function initRoulette(dropList) {
        const container = document.getElementById('rouletteItems');
        container.innerHTML = '';
        for (let i = 0; i < 70; i++) {
            let randomItem = dropList[Math.floor(Math.random() * dropList.length)];
            if (!randomItem) continue;
            
            if (isStandardCase && Math.random() < 0.15) randomItem = genericSecretItem;
            
            const div = document.createElement('div');
            div.className = 'item';
            div.style.borderBottom = `4px solid ${randomItem.color || '#fff'}`;
            div.style.background = `linear-gradient(to top, ${randomItem.color || '#fff'}22, transparent)`;
            
            if (randomItem.type === 'promo' || randomItem.type === 'nothing') {
                div.innerHTML = `<div style="font-size: 40px;">${randomItem.icon}</div><div class="item-text" style="color:${randomItem.color}">${randomItem.name}</div>`;
            } else if (randomItem.type === 'money') {
                div.innerHTML = `<div style="font-size: 16px; font-weight: 800; color:${randomItem.color}">${(randomItem.price||0).toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            } else {
                div.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; width:100%; height:100%;">${renderItemIcon(randomItem, true)}</div>`;
            }
            container.appendChild(div);
        }
    }

    function runRouletteAnimation(winningItem, callback) {
        if (!winningItem) { callback(); return; }
        const winningIndex = 60;
        const rouletteItems = document.getElementById('rouletteItems');
        const winDiv = rouletteItems.children[winningIndex];
        
        if (winDiv) {
            winDiv.style.borderBottom = `4px solid ${winningItem.color}`;
            winDiv.style.background = `linear-gradient(to top, ${winningItem.color}66, transparent)`;
            
            if (winningItem.type === 'promo' || winningItem.type === 'nothing') {
                winDiv.innerHTML = `<div style="font-size: 40px;">${winningItem.icon}</div><div class="item-text" style="color:${winningItem.color}">${winningItem.name}</div>`;
            } else if (winningItem.type === 'money') {
                winDiv.innerHTML = `<div style="font-size: 16px; font-weight: 800; color:${winningItem.color}">${(winningItem.price||0).toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            } else {
                winDiv.innerHTML = `<div style="filter: drop-shadow(0 0 15px ${winningItem.color}); display:flex; justify-content:center; align-items:center; width:100%; height:100%;">${renderItemIcon(winningItem, true)}</div>`;
            }
        }

        if (isStandardCase && Math.random() < 0.15) {
            const offsetOptions = [-2, -1, 1, 2];
            const secretIndex = winningIndex + offsetOptions[Math.floor(Math.random() * offsetOptions.length)];
            if (rouletteItems.children[secretIndex]) {
                const secretDiv = rouletteItems.children[secretIndex];
                secretDiv.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; width:100%; height:100%; filter: drop-shadow(0 0 15px ${genericSecretItem.color});">${renderItemIcon(genericSecretItem, true)}</div>`;
                secretDiv.style.borderBottom = `4px solid ${genericSecretItem.color}`;
                secretDiv.style.background = `linear-gradient(to top, ${genericSecretItem.color}44, transparent)`;
            }
        }

        const itemWidth = 140;
        const rouletteWidth = document.getElementById('roulette').offsetWidth;
        const finalOffset = (winningIndex * itemWidth) - (rouletteWidth / 2) + (itemWidth / 2) + (Math.floor(Math.random() * 80) - 40);

        rouletteItems.style.transition = 'none';
        rouletteItems.style.transform = 'translateX(0)';
        void rouletteItems.offsetWidth;

        rouletteItems.style.transition = 'transform 5s cubic-bezier(0.1, 0.9, 0.1, 1)';
        rouletteItems.style.transform = `translateX(-${finalOffset}px)`;
        
        setTimeout(() => {
            if(winDiv) {
                winDiv.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                winDiv.style.transform = 'scale(1.15)';
                winDiv.style.zIndex = '10';
            }
        }, 5000);

        setTimeout(callback, 5700);
    }

    function showResultModal(title) {
        if (!lastWonItem) return;
        
        document.getElementById('resultTitle').innerText = title;
        
        document.getElementById('resultItemIcon').innerHTML = renderItemIcon(lastWonItem);
        document.getElementById('resultItemName').innerText = lastWonItem.name;
        document.getElementById('resultItemName').style.color = lastWonItem.color;
        
        
        document.getElementById('resultItemIcon').style.filter = `drop-shadow(0 0 40px ${lastWonItem.color})`;
        
        const infoBlock = document.getElementById('resultItemInfoBlock');
        const itemsActions = document.getElementById('resultActionsItems');
        const promoActions = document.getElementById('resultActionsPromo');
        const moneyActions = document.getElementById('resultActionsMoney');

        const priceNum = lastWonItem.price || 0;

        if (lastWonItem.type === 'promo') {
            infoBlock.innerHTML = `–í–∞—à –∫–æ–¥: <span style="color: #00b894; font-weight: bold; font-size: 18px;">${lastWonItem.code}</span>`;
            itemsActions.style.display = 'none'; promoActions.style.display = 'flex'; moneyActions.style.display = 'none';
        } else if (lastWonItem.type === 'nothing' || lastWonItem.type === 'fail') {
            infoBlock.innerHTML = lastWonItem.type === 'fail' ? `–ü—Ä–µ–¥–º–µ—Ç —Å–≥–æ—Ä–µ–ª.` : `–ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞!`;
            itemsActions.style.display = 'none'; promoActions.style.display = 'flex'; moneyActions.style.display = 'none';
        } else if (lastWonItem.type === 'money') {
            infoBlock.innerHTML = `–ó–∞—á–∏—Å–ª–µ–Ω–æ: <span style="color: #00b894; font-weight: bold;">${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</span>`;
            itemsActions.style.display = 'none'; promoActions.style.display = 'none'; moneyActions.style.display = 'flex';
        } else {
            infoBlock.innerHTML = `–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: <span style="color: #fdcb6e; font-weight: bold;">${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</span>`;
            document.getElementById('sellModalPrice').innerText = priceNum.toLocaleString('ru-RU');
            itemsActions.style.display = 'flex'; promoActions.style.display = 'none'; moneyActions.style.display = 'none';
        }
        openModal('resultModal');
    }

    function keepItem() {
        if (!lastWonItem) { finishOpening(); return; }
        inventory.push({ ...lastWonItem, invId: String(Date.now() + Math.random()) });
        saveInventory();
        db.save('pending_claim', 'null');
        finishOpening();
    }

    function sellFromModal() {
        if (!lastWonItem) { finishOpening(); return; }
        const priceNum = lastWonItem.price || 0;
        balance += priceNum;
        updateBalanceUI();
        db.save('pending_claim', 'null');
        sendLog(`üí∏ –ò–≥—Ä–æ–∫ ${userName} –ø—Ä–æ–¥–∞–ª ${lastWonItem.name} —Å—Ä–∞–∑—É –∏–∑ –∫–µ–π—Å–∞ –∑–∞ ${priceNum.toLocaleString('ru-RU')} ‚ÇΩ`);
        finishOpening();
    }
    
    function takeMoney() {
        if (!lastWonItem) { finishOpening(); return; }
        const priceNum = lastWonItem.price || 0;
        balance += priceNum;
        updateBalanceUI();
        db.save('pending_claim', 'null');
        sendLog(`üí∏ –ò–≥—Ä–æ–∫ ${userName} –∑–∞–±—Ä–∞–ª –∏–∑ –î–µ–Ω–µ–∂–Ω–æ–≥–æ –∫–µ–π—Å–∞ ${priceNum.toLocaleString('ru-RU')} ‚ÇΩ`);
        finishOpening();
    }

    function finishOpening() {
        db.save('pending_claim', 'null'); 
        closeModal('resultModal');
        document.getElementById('page-roulette').classList.remove('active');
        if(isBonusMode) {
            document.getElementById('page-bonus').classList.add('active');
            updateBonusButton();
        } else if(craftSelectedIds.length > 0 || upgMyItem) {
            document.getElementById('page-games').classList.add('active');
            resetCrafting(); upgMyItem = null; updateUpgUI();
        } else if(isStandardCase) {
            document.getElementById('page-case-view').classList.add('active');
        } else {
            document.getElementById('page-cases').classList.add('active');
        }
        isOpening = false; isBonusMode = false; isStandardCase = false;
    }

    function renderInventory() {
        const grid = document.getElementById('inventoryGrid');
        document.getElementById('invCount').innerText = inventory.length;
        grid.innerHTML = '';
        if (inventory.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8b8b99; padding: 40px 0;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>';
            return;
        }
        
        const sortedInv = [...inventory].sort((a, b) => (b.price || 0) - (a.price || 0));
        sortedInv.forEach(item => {
            const priceNum = item.price || 0;
            grid.innerHTML += `
                <div class="inv-item" style="border-top: 3px solid ${item.color};">
                    <div class="inv-item-img">${renderItemIcon(item)}</div>
                    <div class="inv-item-name" style="color: ${item.color}">${item.name}</div>
                    <div class="inv-item-price">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    <div style="display: flex; gap: 5px; width: 100%; margin-top: 10px;">
                        <button class="btn btn-outline" style="flex: 1; padding: 6px; font-size: 11px; border-color: rgba(255,255,255,0.1); color: #fff;" onclick="sellSingleItem('${item.invId}', ${priceNum}, '${item.name}')">–ü—Ä–æ–¥–∞—Ç—å</button>
                        <button class="btn btn-success" style="flex: 1; padding: 6px; font-size: 11px;" onclick="openWithdrawModal('${item.invId}')">–í—ã–≤–æ–¥</button>
                    </div>
                </div>
            `;
        });
    }

    function sellSingleItem(invId, price, name) {
        inventory = inventory.filter(item => String(item.invId) !== String(invId));
        balance += price; updateBalanceUI(); saveInventory(); renderInventory();
        sendLog(`üí∏ –ò–≥—Ä–æ–∫ ${userName} –ø—Ä–æ–¥–∞–ª ${name} –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∑–∞ ${price.toLocaleString('ru-RU')} ‚ÇΩ`);
    }

    function openWithdrawModal(invId) {
        const item = inventory.find(i => String(i.invId) === String(invId));
        if (!item || (item.price || 0) < 150000) { 
            alert("–í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –æ—Ç 150 000 ‚ÇΩ!"); return; 
        }
        currentWithdrawItemId = invId;
        document.getElementById('wdItemName').innerText = item.name;
        document.getElementById('robloxNickInput').value = '';
        openModal('withdrawModal');
    }

    function confirmWithdraw() {
        const nick = document.getElementById('robloxNickInput').value.trim();
        if (!/^[a-zA-Z0-9_]{3,20}$/.test(nick)) { alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫!'); return; }
        const btn = document.getElementById('wdSubmitBtn');
        btn.innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...'; btn.disabled = true;

        setTimeout(() => {
            const item = inventory.find(i => String(i.invId) === String(currentWithdrawItemId));
            if (!item) return;
            
            inventory = inventory.filter(i => String(i.invId) !== String(currentWithdrawItemId));
            saveInventory(); renderInventory(); closeModal('withdrawModal');
            
            const priceNum = item.price || 0;
            sendLog(`üì§ –ò–≥—Ä–æ–∫ ${userName} –∑–∞–ø—Ä–æ—Å–∏–ª –≤—ã–≤–æ–¥ ${item.name} –Ω–∞ –Ω–∏–∫ ${nick}`);
            
            const payloadStr = `${item.id}||${priceNum}||${nick}`;
            const payload = btoa(unescape(encodeURIComponent(payloadStr))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            
            tg.openTelegramLink(`https://t.me/StockOGCasesBot?start=wd_${payload}`);
            
            btn.innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É'; btn.disabled = false;
        }, 300);
    }

    function applyPromo(btn) {
        const code = document.getElementById('promoInput').value.trim();
        if (!code) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥!"); return; }
        btn.disabled = true; btn.innerText = '...';
        tg.openTelegramLink(`https://t.me/StockOGCasesBot?start=promo_${code}`);
        setTimeout(() => { document.getElementById('promoInput').value = ''; btn.disabled = false; btn.innerText = '–û–ö'; }, 2000);
    }

    function copyRefLink() {
        navigator.clipboard.writeText(document.getElementById('refLink').innerText).then(() => { alert('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); });
    }

    function renderCraftInventory() {
        const grid = document.getElementById('craftInventoryGrid'); grid.innerHTML = '';
        
        const standardInv = inventory.filter(i => !i.isSecret && i.type !== 'money' && i.type !== 'key');
        if (standardInv.length < 3) {
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8b8b99; padding: 20px 0;">–î–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –æ–±—ã—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞ (–ö–ª—é—á–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è)</div>'; return;
        }
        standardInv.forEach(item => {
            const isSelected = craftSelectedIds.includes(String(item.invId));
            grid.innerHTML += `
                <div class="inv-item ${isSelected ? 'selected' : ''}" style="border-top: 3px solid ${item.color};" onclick="toggleCraftItem('${item.invId}')">
                    <div class="inv-item-img">${renderItemIcon(item)}</div>
                    <div class="inv-item-name">${item.name}</div>
                </div>
            `;
        });
        updateCraftSlots();
    }

    function toggleCraftItem(invId) {
        if (craftSelectedIds.includes(String(invId))) {
            craftSelectedIds = craftSelectedIds.filter(id => id !== String(invId));
        } else if (craftSelectedIds.length < 3) {
            craftSelectedIds.push(String(invId));
        }
        renderCraftInventory();
    }

    function updateCraftSlots() {
        for(let i=0; i<3; i++) {
            const slot = document.getElementById(`slot-${i}`);
            if (craftSelectedIds[i]) {
                const item = inventory.find(x => String(x.invId) === String(craftSelectedIds[i]));
                slot.innerHTML = renderItemIcon(item); slot.classList.add('filled');
            } else { slot.innerHTML = ''; slot.classList.remove('filled'); }
        }
        const btn = document.getElementById('btnCraft');
        if (craftSelectedIds.length === 3) { btn.style.opacity = '1'; btn.style.cursor = 'pointer'; }
        else { btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; }
    }

    function executeCraft() {
        if (craftSelectedIds.length < 3 || isOpening) return;
        isOpening = true; isStandardCase = false; 
        stats.crafts += 1; document.getElementById('statCrafts').innerText = stats.crafts; saveStats();

        inventory = inventory.filter(item => !craftSelectedIds.includes(String(item.invId))); saveInventory();
        
        document.getElementById('page-games').classList.remove('active');
        document.getElementById('page-roulette').classList.add('active');
        document.getElementById('openingCaseName').innerText = "–ö–æ–Ω—Ç—Ä–∞–∫—Ç...";

        const possibleDrops = Object.values(allItems).filter(i => !i.isSecret && i.type === 'item');
        initRoulette(possibleDrops);
        
        const baseWonItem = getWeightedRandomItem(possibleDrops);
        lastWonItem = JSON.parse(JSON.stringify(baseWonItem));
        if (!lastWonItem.price) lastWonItem.price = 0;

        db.save('pending_claim', JSON.stringify(lastWonItem));

        runRouletteAnimation(lastWonItem, () => {
            sendLog(`‚öôÔ∏è –ò–≥—Ä–æ–∫ ${userName} —Å–¥–µ–ª–∞–ª –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏ –ø–æ–ª—É—á–∏–ª: ${lastWonItem.name}`);
            showResultModal('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            craftSelectedIds = [];
        });
    }

    function resetCrafting() {
        craftSelectedIds = [];
        if(document.getElementById('tab-contract').classList.contains('active')) renderCraftInventory();
    }

    function openUpgMyModal() {
        const grid = document.getElementById('upgMyGrid'); grid.innerHTML = '';
        const standardInv = inventory.filter(i => !i.isSecret && i.type !== 'money' && i.type !== 'key');
        if (standardInv.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8b8b99;">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>';
        } else {
            standardInv.forEach(item => {
                const priceNum = item.price || 0;
                grid.innerHTML += `
                    <div class="inv-item" style="border-top: 3px solid ${item.color};" onclick="selectUpgMy('${item.invId}')">
                        <div class="inv-item-img">${renderItemIcon(item)}</div>
                        <div class="inv-item-name">${item.name}</div>
                        <div class="inv-item-price">${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>`;
            });
        }
        openModal('upgMyModal');
    }

    function selectUpgMy(invId) {
        upgMyItem = inventory.find(i => String(i.invId) === String(invId)); 
        closeModal('upgMyModal'); updateUpgUI();
    }

    function openUpgTargetModal() {
        const grid = document.getElementById('upgTargetGrid'); grid.innerHTML = '';
        const targetPool = Object.values(allItems).filter(d => d.type === 'item' && !d.isSecret && (d.price || 0) > 10000);
        
        targetPool.sort((a,b) => (a.price || 0) - (b.price || 0)).forEach(item => {
            let p = item.price || 0;
            grid.innerHTML += `
                <div class="inv-item" style="border-top: 3px solid ${item.color};" onclick="selectUpgTarget('${item.id}')">
                    <div class="inv-item-img">${renderItemIcon(item)}</div>
                    <div class="inv-item-name">${item.name}</div>
                    <div class="inv-item-price">${p.toLocaleString('ru-RU')} ‚ÇΩ</div>
                </div>`;
        });
        openModal('upgTargetModal');
    }

    function selectUpgTarget(id) {
        upgTargetItem = allItems[id]; closeModal('upgTargetModal'); updateUpgUI();
    }

    function updateUpgUI() {
        const mySlot = document.getElementById('upg-my-slot');
        if (upgMyItem) { mySlot.innerHTML = renderItemIcon(upgMyItem); mySlot.classList.add('filled'); }
        else { mySlot.innerHTML = '<span style="font-size:12px; color:#8b8b99;">–í–∞—à<br>–ø—Ä–µ–¥–º–µ—Ç</span>'; mySlot.classList.remove('filled'); }

        const targetSlot = document.getElementById('upg-target-slot');
        if (upgTargetItem) { targetSlot.innerHTML = renderItemIcon(upgTargetItem); targetSlot.classList.add('filled'); }
        else { targetSlot.innerHTML = '<span style="font-size:12px; color:#8b8b99;">–ñ–µ–ª–∞–µ–º—ã–π<br>–ø—Ä–µ–¥–º–µ—Ç</span>'; targetSlot.classList.remove('filled'); }

        let chance = 0;
        if (upgMyItem && upgTargetItem) {
            let trgP = upgTargetItem.price || 1;
            let myP = upgMyItem.price || 0;
            chance = Math.min((myP / trgP) * 100 * 0.9, 95);
        }

        document.getElementById('upg-chance').innerText = `–®–∞–Ω—Å: ${chance.toFixed(1)}%`;
        const btn = document.getElementById('btnUpgrade');
        if (upgMyItem && upgTargetItem) { btn.style.opacity = '1'; btn.style.cursor = 'pointer'; }
        else { btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; }
    }

    function executeUpgrade() {
        if (!upgMyItem || !upgTargetItem || isOpening) return;
        isOpening = true; isStandardCase = false;
        
        let trgP = upgTargetItem.price || 1;
        let myP = upgMyItem.price || 0;
        let chance = Math.min((myP / trgP) * 100 * 0.9, 95);
        let roll = Math.random() * 100;
        let isWin = roll <= chance;

        inventory = inventory.filter(i => String(i.invId) !== String(upgMyItem.invId)); saveInventory();
        
        document.getElementById('page-games').classList.remove('active');
        document.getElementById('page-roulette').classList.add('active');
        document.getElementById('openingCaseName').innerText = "–ê–ø–≥—Ä–µ–π–¥...";

        const container = document.getElementById('rouletteItems'); container.innerHTML = '';
        for (let i = 0; i < 70; i++) {
            let item = (Math.random() < 0.5) ? upgTargetItem : { icon: '‚ùå', color: '#8b8b99' };
            const div = document.createElement('div'); div.className = 'item'; div.style.borderBottom = `4px solid ${item.color}`;
            div.innerHTML = `<div>${renderItemIcon(item)}</div>`;
            container.appendChild(div);
        }

        if (isWin) {
            lastWonItem = JSON.parse(JSON.stringify(upgTargetItem));
        } else {
            lastWonItem = { id: 'fail', icon: '‚ùå', name: '–ü–†–û–í–ê–õ', color: '#8b8b99', price: 0, type: 'fail' };
        }
        if (!lastWonItem.price) lastWonItem.price = 0;

        db.save('pending_claim', JSON.stringify(lastWonItem));

        runRouletteAnimation(lastWonItem, () => {
            sendLog(`‚¨ÜÔ∏è –ò–≥—Ä–æ–∫ ${userName} —Å–¥–µ–ª–∞–ª –∞–ø–≥—Ä–µ–π–¥: ${upgMyItem.name} -> ${upgTargetItem.name}. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${isWin ? '–£–°–ü–ï–•' : '–ü–†–û–í–ê–õ'}`);
            if (isWin) { showResultModal('–ê–ø–≥—Ä–µ–π–¥ —É—Å–ø–µ—à–µ–Ω!'); }
            else { showResultModal('–ü—Ä–æ–≤–∞–ª...'); }
            upgMyItem = null; upgTargetItem = null;
        });
    }
</script>
</body>
</html>
