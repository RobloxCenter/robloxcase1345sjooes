<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Roblox Drop App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body {font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background-color:#0d0d12;color:#ffffff;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
        
        img { border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); object-fit: cover; }
        
        .header {display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:rgba(22,22,28,0.8);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.05);z-index:10;}
        .user-info {display:flex;align-items:center;gap:12px;}
        .avatar {width:40px;height:40px;background:linear-gradient(135deg,#6c5ce7,#a29bfe);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:18px;box-shadow:0 4px 10px rgba(108,92,231,0.3);}
        .balance-container {background:rgba(0,184,148,0.15);border:1px solid rgba(0,184,148,0.4);padding:8px 15px;border-radius:12px;font-weight:800;color:#00b894;font-size:16px;display:flex;align-items:center;gap:5px;box-shadow:0 0 15px rgba(0,184,148,0.1);}
        .content {flex-grow:1;overflow-y:auto;padding:20px;padding-bottom:100px;}
        .section-title {margin:0 0 20px 0;font-size:24px;font-weight:800;background:linear-gradient(90deg,#ffffff,#8b8b99);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .cases-grid {display:grid;grid-template-columns:repeat(2,1fr);gap:15px;}
        .case-card {background:linear-gradient(180deg,#1f1f25 0%,#16161a 100%);border-radius:20px;padding:20px 15px;text-align:center;border:1px solid rgba(255,255,255,0.08);cursor:pointer;position:relative;overflow:hidden;transition:all 0.3s ease;}
        .case-card:active {transform:scale(0.95);}
        .case-card-img {height:90px;margin-bottom:15px;display:flex;align-items:center;justify-content:center;font-size:60px;filter:drop-shadow(0 10px 15px rgba(0,0,0,0.6));}
        .case-card-img img {max-width:100%;max-height:100%;}
        .case-card-title {font-size:16px;font-weight:800;margin-bottom:8px;}
        .case-card-price {color:#fdcb6e;font-weight:bold;font-size:14px;background:rgba(253,203,110,0.15);display:inline-block;padding:6px 12px;border-radius:8px;}
        .btn {background:linear-gradient(135deg,#6c5ce7,#a29bfe);border:none;color:white;padding:14px 20px;border-radius:12px;font-weight:bold;font-size:16px;cursor:pointer;width:100%;transition:transform 0.1s;box-shadow:0 4px 15px rgba(108,92,231,0.4); display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn:active {transform:scale(0.96);}
        .btn:disabled {opacity: 0.5; cursor: not-allowed; transform: none;}
        .btn-success {background:linear-gradient(135deg,#00b894,#55efc4);box-shadow:0 4px 15px rgba(0,184,148,0.4);}
        .btn-warning {background:linear-gradient(135deg,#fdcb6e,#ffeaa7);box-shadow:0 4px 15px rgba(253,203,110,0.4);color:#2d3436;}
        .btn-primary {background:linear-gradient(135deg,#0984e3,#74b9ff);box-shadow:0 4px 15px rgba(9,132,227,0.4);}
        .btn-outline {background:transparent;border:1px solid rgba(255,255,255,0.2);box-shadow:none;}
        .panel {background:#16161a;border-radius:20px;padding:20px;text-align:center;border:1px solid rgba(255,255,255,0.05);margin-bottom:20px;}
        .inventory-grid {display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
        .inv-item {background:#1f1f25;border-radius:16px;padding:15px 10px;text-align:center;border:1px solid #2a2a35;position:relative;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:space-between;}
        .inv-item.selected {border-color:#6c5ce7;background:rgba(108,92,231,0.1);transform:translateY(-3px);box-shadow:0 8px 20px rgba(108,92,231,0.2);}
        .inv-item-img {height:50px;margin-bottom:10px;display:flex;align-items:center;justify-content:center;font-size:40px;}
        .inv-item-img img {max-width:100%;max-height:100%;}
        .inv-item-name {font-size:12px;font-weight:700;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:8px;}
        .inv-item-price {font-size:11px;color:#8b8b99;background:rgba(255,255,255,0.05);padding:4px 8px;border-radius:6px;}
        .craft-slots {display:flex;justify-content:center;gap:15px;margin:20px 0 25px 0;}
        .craft-slot {width:80px;height:80px;background:#1f1f25;border:2px dashed rgba(255,255,255,0.2);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:40px;}
        .craft-slot img {max-width: 80%; max-height: 80%; border:none;}
        .craft-slot.filled {border-style:solid;border-color:#6c5ce7;background:rgba(108,92,231,0.1);box-shadow:0 0 20px rgba(108,92,231,0.2);transform:scale(1.05);}
        .roulette-container {display:none;flex-direction:column;align-items:center;justify-content:center;height:60vh;}
        .roulette-wrapper {width:100%;height:160px;background:#16161a;overflow:hidden;position:relative;border-radius:20px;border:1px solid rgba(255,255,255,0.1);box-shadow:inset 0 0 40px rgba(0,0,0,0.8),0 10px 30px rgba(0,0,0,0.5);}
        .roulette-items {display:flex;height:100%;}
        .item {min-width:140px;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;border-right:1px solid rgba(255,255,255,0.03);font-size:60px;}
        .item img {max-width:80px;max-height:80px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); border:none;}
        .item-text {font-size:16px;font-weight:bold;text-align:center;padding:0 10px;}
        .selector-line {position:absolute;top:0;bottom:0;left:50%;width:4px;background:#fdcb6e;z-index:10;transform:translateX(-50%);box-shadow:0 0 20px #fdcb6e;}
        .nav {display:flex;justify-content:space-between;background:rgba(22,22,28,0.95);backdrop-filter:blur(15px);padding:12px 5px 20px 5px;border-top:1px solid rgba(255,255,255,0.05);position:fixed;bottom:0;width:100%;z-index:100;}
        .nav-btn {background:none;color:#8b8b99;border:none;font-size:11px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;flex:1;}
        .nav-icon {font-size:22px;opacity:0.5;filter:grayscale(100%); transition: all 0.2s;}
        .nav-btn.active {color:#ffffff;}
        .nav-btn.active .nav-icon {opacity:1;filter:grayscale(0%);transform:translateY(-4px) scale(1.1);}
        .page {display:none;animation:fadeIn 0.4s ease;}
        .page.active {display:block;}
        .tab-content {display:none;}
        .tab-content.active {display:block;}
        
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);align-items:center;justify-content:center;z-index:200;}
        .modal-content {background:#16161a;padding:30px 25px;border-radius:28px;text-align:center;border:1px solid rgba(255,255,255,0.1);width:90%;max-width:360px;box-shadow:0 25px 50px rgba(0,0,0,0.5);max-height:85vh;overflow-y:auto; transform: scale(0.95); opacity: 0;}
        
        #resultItemIcon img { max-height: 160px; max-width: 100%; object-fit: contain; }
        
        .modal-overlay.show .modal-content { animation: scaleUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .modal-overlay.show {display:flex;animation:fadeIn 0.2s ease;}
        
        .drops-list-grid {display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
        .drop-item-card {background:#1f1f25;border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:10px 5px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center; min-height: 110px;}
        .drop-item-card img { max-width: 60px; max-height: 60px; margin-bottom: 8px;}
        .ref-box {display:flex;align-items:center;background:#1f1f25;border-radius:12px;padding:10px;margin-top:10px;border:1px solid rgba(255,255,255,0.1);}
        .ref-link {flex-grow:1;color:#00b894;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        
        .multi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-height: 40vh; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
        .multi-grid img { max-height: 40px; max-width: 100%; object-fit: contain; }

        @keyframes fadeIn {from{opacity:0;} to{opacity:1;}}
    </style>
</head>
<body>

<div class="header">
    <div class="user-info">
        <div class="avatar" id="userAvatar">R</div>
        <div>
            <div style="font-weight: 800; font-size: 15px;" id="tgUserName">–ò–≥—Ä–æ–∫</div>
            <div style="font-size: 12px; color: #8b8b99;" id="tgUserStatus">–ù–æ–≤–∏—á–æ–∫</div>
        </div>
    </div>
    <div class="balance-container">
        <span id="balanceAmount">0</span> ‚ÇΩ
    </div>
</div>

<div class="content" style="padding-bottom: 80px;">
    <div id="page-cases" class="page active">
        <h2 class="section-title">–ú–∞–≥–∞–∑–∏–Ω</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" id="btnTabCases" onclick="switchShopTab('cases')">–ö–µ–π—Å—ã</button>
            <button class="btn btn-outline" id="btnTabKeys" onclick="switchShopTab('keys')">–ö–ª—é—á–∏</button>
        </div>
        <div class="cases-grid" id="casesGrid"></div>
        <div class="cases-grid" id="keysGrid" style="display: none;"></div>
    </div>

    <div id="page-case-view" class="page" style="margin: -20px; padding-bottom: 40px;">
        <div style="padding: 20px; cursor: pointer; color: #8b8b99; font-weight: bold; display: flex; align-items: center; gap: 5px; background: rgba(22,22,28,0.8); border-bottom: 1px solid rgba(255,255,255,0.05);" onclick="switchPage('cases', document.querySelectorAll('.nav-btn')[0])">
            <span style="font-size: 18px;">‚Üê</span> –ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω
        </div>
        
        <div style="width: 100%; padding: 30px 20px; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, rgba(108,92,231,0.15) 0%, transparent 70%);">
            <img id="viewCaseImg" src="" style="width: 200px; height: 200px; border-radius: 16px; filter: drop-shadow(0 15px 30px rgba(0,0,0,0.6)); border: 2px solid rgba(255,255,255,0.1);">
        </div>
        
        <div style="padding: 0 20px; text-align: center;">
            <p style="color: #8b8b99; font-size: 14px; margin-bottom: 15px;">–ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É –∏ –ø–æ–ª—É—á–∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã!</p>
            
            <div id="amountSelector" style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button class="btn btn-outline" style="width: 40px; height: 40px; padding: 0; display:flex; align-items:center; justify-content:center; font-size: 20px; border-radius: 12px;" onclick="changeCaseAmount(-1)">-</button>
                <span id="caseAmount" style="font-size: 22px; font-weight: 800; width: 30px; text-align: center;">1</span>
                <button class="btn btn-outline" style="width: 40px; height: 40px; padding: 0; display:flex; align-items:center; justify-content:center; font-size: 20px; border-radius: 12px;" onclick="changeCaseAmount(1)">+</button>
                <button class="btn btn-outline" style="width: auto; height: 40px; padding: 0 12px; font-size: 13px;" onclick="setCaseAmount(10)">MAX</button>
            </div>

            <button class="btn btn-primary" id="viewCaseBtn" style="padding: 16px; font-size: 16px;" onclick="confirmOpenCase()">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
        
        <h3 style="margin: 30px 20px 15px; font-size: 18px; color: #fff;">–í–æ–∑–º–æ–∂–Ω—ã–π –¥—Ä–æ–ø:</h3>
        <div class="drops-list-grid" id="viewCaseDrops" style="padding: 0 20px;"></div>
    </div>

    <div id="page-roulette" class="roulette-container page">
        <h2 id="openingCaseName" style="margin-top: 0; margin-bottom: 30px; font-size: 28px; color: #fff; text-shadow: 0 0 20px rgba(108, 92, 231, 0.5); text-align: center;">–û—Ç–∫—Ä—ã–≤–∞–µ–º...</h2>
        <div class="roulette-wrapper" id="roulette">
            <div class="selector-line"></div>
            <div class="roulette-items" id="rouletteItems"></div>
        </div>
    </div>

    <div id="page-inventory" class="page">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="section-title" style="margin: 0;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
            <div style="font-size: 14px; color: #8b8b99; background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px;">
                –í—Å–µ–≥–æ: <span id="invCount" style="color: white; font-weight: bold;">0</span>
            </div>
        </div>
        <div class="inventory-grid" id="inventoryGrid"></div>
    </div>

    <div id="page-games" class="page">
        <h2 class="section-title">–ò–≥—Ä—ã</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="btn" id="btnTabContract" onclick="switchGameTab('contract')">–ö–æ–Ω—Ç—Ä–∞–∫—Ç</button>
            <button class="btn btn-outline" id="btnTabUpgrade" onclick="switchGameTab('upgrade')">–ê–ø–≥—Ä–µ–π–¥</button>
        </div>

        <div id="tab-contract" class="tab-content active">
            <div class="panel">
                <p style="color: #8b8b99; font-size: 14px; margin-top: 0;">–í—ã–±–µ—Ä–∏—Ç–µ 3 –æ–±—ã—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞. –û–Ω–∏ –∏—Å—á–µ–∑–Ω—É—Ç, –∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ 1 —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö)!</p>
                <div class="craft-slots" id="craftSlots">
                    <div class="craft-slot" id="slot-0"></div>
                    <div class="craft-slot" id="slot-1"></div>
                    <div class="craft-slot" id="slot-2"></div>
                </div>
                <button class="btn btn-success" id="btnCraft" style="opacity: 0.5; cursor: not-allowed;" onclick="executeCraft()">–°–∫—Ä–∞—Ñ—Ç–∏—Ç—å</button>
            </div>
            <h3 style="margin: 25px 0 15px 0; font-size: 18px; color: #fff;">–í–∞—à –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:</h3>
            <div class="inventory-grid" id="craftInventoryGrid"></div>
        </div>

        <div id="tab-upgrade" class="tab-content">
            <div class="panel">
                <p style="color: #8b8b99; font-size: 14px; margin-top: 0;">–£–ª—É—á—à–∞–π—Ç–µ —Å–≤–æ–∏ –¥–µ—à–µ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ –¥–æ—Ä–æ–≥–∏–µ!</p>
                <div style="display: flex; justify-content: space-around; align-items: center; margin: 20px 0;">
                    <div class="craft-slot" id="upg-my-slot" onclick="openUpgMyModal()" style="cursor:pointer; flex-direction:column; font-size:12px; color:#8b8b99;">–í–∞—à<br>–ø—Ä–µ–¥–º–µ—Ç</div>
                    <div style="font-size:24px;">‚û°Ô∏è</div>
                    <div class="craft-slot" id="upg-target-slot" onclick="openUpgTargetModal()" style="cursor:pointer; flex-direction:column; font-size:12px; color:#8b8b99;">–ñ–µ–ª–∞–µ–º—ã–π<br>–ø—Ä–µ–¥–º–µ—Ç</div>
                </div>
                <div id="upg-chance" style="margin-bottom: 20px; font-weight: bold; color: #fdcb6e; font-size: 18px;">–®–∞–Ω—Å: 0%</div>
                <button class="btn btn-warning" id="btnUpgrade" style="opacity: 0.5; cursor: not-allowed;" onclick="executeUpgrade()">–ê–ø–≥—Ä–µ–π–¥</button>
            </div>
        </div>
    </div>

    <div id="page-bonus" class="page">
        <h2 class="section-title">–£–¥–∞—á–∞</h2>
        <div class="panel">
            <div style="font-size: 70px; margin-bottom: 10px; filter: drop-shadow(0 0 20px rgba(253, 203, 110, 0.5));">üé∞</div>
            <h3 style="margin: 0 0 10px 0;">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä—É–ª–µ—Ç–∫–∞</h3>
            <p style="color: #8b8b99; font-size: 14px; margin-bottom: 20px;">–ö—Ä—É—Ç–∏ —Ä—É–ª–µ—Ç–∫—É —Ä–∞–∑ –≤ 24 —á–∞—Å–∞! –®–∞–Ω—Å 30% –ø–æ–ª—É—á–∏—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞.</p>
            <button class="btn btn-warning" id="btnBonusSpin" onclick="spinBonusWheel()">–ö—Ä—É—Ç–∏—Ç—å (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)</button>
        </div>
    </div>

    <div id="page-profile" class="page">
        <h2 class="section-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
        
        <div class="panel" style="text-align: left; padding: 20px; border-color: #00b894; box-shadow: 0 0 15px rgba(0, 184, 148, 0.15); margin-bottom: 20px;" id="profileRobloxBlock">
            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #55efc4;">üéÆ –ü—Ä–∏–≤—è–∑–∫–∞ Roblox</h3>
            <div id="robloxLinkedStatus">
                <p style="color: #8b8b99; font-size: 13px; margin: 0 0 15px 0;">–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç Roblox, —á—Ç–æ–±—ã –≤—ã–≤–æ–¥–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã. –û—Ç–≤—è–∑–∞—Ç—å –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ!</p>
                <button class="btn btn-success" style="width: 100%; padding: 12px;" onclick="openBindModal()">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>

        <div class="panel" style="text-align: left; display: flex; justify-content: space-between; padding: 20px;">
            <div>
                <p style="color: #8b8b99; font-size: 13px; margin: 0 0 5px 0;">–û—Ç–∫—Ä—ã—Ç–æ –∫–µ–π—Å–æ–≤</p>
                <p id="statOpened" style="font-size: 24px; font-weight: bold; margin: 0; color: #fff;">0</p>
            </div>
            <div style="text-align: right;">
                <p style="color: #8b8b99; font-size: 13px; margin: 0 0 5px 0;">–£—Å–ø–µ—à–Ω—ã—Ö –∫—Ä–∞—Ñ—Ç–æ–≤</p>
                <p id="statCrafts" style="font-size: 24px; font-weight: bold; margin: 0; color: #fff;">0</p>
            </div>
        </div>
        
        <button class="btn btn-success" style="margin-bottom: 20px; padding: 18px;" onclick="startTopupProcess()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        
        <div class="panel" style="text-align: left; padding: 20px; border-color: #6c5ce7; box-shadow: 0 0 15px rgba(108, 92, 231, 0.15);">
            <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #a29bfe;">üéÅ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞</h3>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="promoInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="flex-grow: 1; padding: 12px 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: #1f1f25; color: white; font-size: 16px; outline: none;">
                <button class="btn" style="width: auto; padding: 12px 25px;" onclick="applyPromo(this)">–û–ö</button>
            </div>
        </div>

        <div class="panel" style="text-align: left; padding: 20px;">
            <h3 style="margin: 0 0 10px 0; font-size: 16px;">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</h3>
            <p style="color: #8b8b99; font-size: 13px; margin: 0;">–ü–æ–ª—É—á–∞–π 10% –æ—Ç –∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π!</p>
            <div class="ref-box">
                <div class="ref-link" id="refLink">t.me/StockOGCasesBot?start=ref</div>
                <button class="btn btn-outline" style="width: auto; padding: 6px 12px; font-size: 12px;" onclick="copyRefLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchPage('cases', this)"><div class="nav-icon">üì¶</div><span>–ú–∞–≥–∞–∑–∏–Ω</span></button>
    <button class="nav-btn" onclick="switchPage('inventory', this)"><div class="nav-icon">üéí</div><span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span></button>
    <button class="nav-btn" onclick="switchPage('games', this)"><div class="nav-icon">üéÆ</div><span>–ò–≥—Ä—ã</span></button>
    <button class="nav-btn" onclick="switchPage('bonus', this)"><div class="nav-icon">üé°</div><span>–£–¥–∞—á–∞</span></button>
    <button class="nav-btn" onclick="switchPage('profile', this)"><div class="nav-icon">üë§</div><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
</div>

<div class="modal-overlay" id="bindModal">
    <div class="modal-content" style="width: 90%; max-width: 380px;">
        <h2 style="margin-top: 0; color: #fff;">–ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
        <div id="bindStep1">
            <p style="color: #8b8b99; font-size: 14px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–æ—á–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º –≤ Roblox. –í—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –µ–≥–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∑–∂–µ.</p>
            <input type="text" id="bindUsernameInput" placeholder="–ù–∏–∫ –≤ Roblox" style="width: 100%; padding: 14px; margin: 15px 0; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); background: #1f1f25; color: white; font-size: 16px; outline:none;">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" style="flex: 1;" onclick="closeModal('bindModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="goToBindStep2()">–î–∞–ª–µ–µ ‚û°Ô∏è</button>
            </div>
        </div>
        <div id="bindStep2" style="display: none;">
            <p style="color: #8b8b99; font-size: 14px;">1. –ó–∞–π–¥–∏—Ç–µ –≤ Roblox –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.</p>
            <p style="color: #8b8b99; font-size: 14px;">2. –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ —Ä–∞–∑–¥–µ–ª <b>About (–û–ø–∏—Å–∞–Ω–∏–µ)</b> –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ:</p>
            <div style="background: rgba(108,92,231,0.15); border: 1px dashed #6c5ce7; padding: 15px; border-radius: 12px; margin: 15px 0; font-family: monospace; font-size: 18px; color: #a29bfe; font-weight: bold; letter-spacing: 1px;" id="bindPhraseDisplay">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
            <div style="color: #fdcb6e; font-weight: bold; font-size: 18px; margin-bottom: 20px;">
                –û—Å—Ç–∞–ª–æ—Å—å: <span id="bindTimerDisplay">03:00</span>
            </div>
            <button class="btn btn-success" id="btnVerifyRoblox" style="width: 100%; margin-bottom: 10px;" onclick="verifyRobloxAcc()">–Ø —É–∫–∞–∑–∞–ª —Ñ—Ä–∞–∑—É</button>
            <button class="btn btn-outline" style="width: 100%;" onclick="closeBindModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="resultModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff; font-size: 26px;" id="resultTitle">–û—Ç–ª–∏—á–Ω—ã–π –¥—Ä–æ–ø!</h2>
        <div id="resultItemIcon" style="font-size: 90px; margin: 25px 0; display:flex; justify-content:center; align-items:center;">üó°Ô∏è</div>
        <div id="resultItemName" style="font-weight: 800; font-size: 22px; margin-bottom: 8px; line-height: 1.2;">–ú–µ—á</div>
        <div id="resultItemInfoBlock" style="color: #8b8b99; font-size: 15px; margin-bottom: 30px;"></div>
        <div style="display: flex; flex-direction: column; gap: 12px;" id="resultActionsContainer"></div>
    </div>
</div>

<div class="modal-overlay" id="multiResultModal">
    <div class="modal-content" style="width: 95%; max-width: 400px; padding: 25px 15px;">
        <h2 style="margin-top: 0; color: #fff; font-size: 22px;">–î—Ä–æ–ø —Å <span id="multiCaseCount" style="color: #a29bfe;">5</span> –∫–µ–π—Å–æ–≤</h2>
        <div class="multi-grid" id="multiResultGrid"></div>
        <div style="font-size: 14px; color: #8b8b99; margin-bottom: 15px;">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span id="multiTotalValue" style="color: #fdcb6e; font-weight: bold;">0 ‚ÇΩ</span></div>
        <div style="display: flex; flex-direction: column; gap: 10px;" id="multiActionsContainer"></div>
    </div>
</div>

<div class="modal-overlay" id="withdrawModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff;">–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥</h2>
        <p style="color: #8b8b99; font-size: 14px;">–ü—Ä–µ–¥–º–µ—Ç: <strong id="wdItemName" style="color: white;"></strong></p>
        <p style="color: #8b8b99; font-size: 14px; margin-bottom: 20px;">–ê–∫–∫–∞—É–Ω—Ç: <strong id="wdTargetAcc" style="color: #00b894;"></strong></p>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-success" id="wdSubmitBtn" onclick="confirmWithdraw()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–≤–æ–¥</button>
            <button class="btn btn-outline" onclick="closeModal('withdrawModal')">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="upgMyModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff;">–í–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã</h2>
        <div class="inventory-grid" id="upgMyGrid"></div>
        <button class="btn btn-outline" style="margin-top:15px;" onclick="closeModal('upgMyModal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div class="modal-overlay" id="upgTargetModal">
    <div class="modal-content">
        <h2 style="margin-top: 0; color: #fff;">–í—ã–±–æ—Ä —Ü–µ–ª–∏</h2>
        <div class="inventory-grid" id="upgTargetGrid"></div>
        <button class="btn btn-outline" style="margin-top:15px;" onclick="closeModal('upgTargetModal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => { if(e.key==='F12' || (e.ctrlKey && e.shiftKey && (e.key==='I' || e.key==='J' || e.key==='C')) || (e.ctrlKey && e.key==='U')) e.preventDefault() });
    setInterval(function(){(function(){return false;}['constructor']('debugger')['call']());}, 50);

    let tg = window.Telegram.WebApp;
    tg.expand();

    const db = {
        save: function(key, val) { 
            try {
                let p = JSON.parse(val);
                if (p && typeof p === 'object' && !Array.isArray(p)) {
                    p._ts = Date.now();
                    val = JSON.stringify(p);
                }
            } catch(e) {}
            
            try { localStorage.setItem(key, val); } catch(e) {}
            try { if(tg.CloudStorage) { tg.CloudStorage.setItem(key, val); } } catch(e) {}
        },
        load: function(key) {
            return new Promise((resolve) => {
                let localVal = null;
                try { localVal = localStorage.getItem(key); } catch(e) {}
                
                if(tg.CloudStorage) {
                    let resolved = false;
                    let fallback = setTimeout(() => {
                        if(!resolved) { resolved = true; resolve(localVal); }
                    }, 500);
                    
                    try {
                        tg.CloudStorage.getItem(key, (err, cloudVal) => {
                            if(!resolved) {
                                resolved = true;
                                clearTimeout(fallback);
                                if(err || !cloudVal || cloudVal === 'undefined') { 
                                    resolve(localVal); 
                                } else { 
                                    let lTs = 0, cTs = 0;
                                    try { if(localVal) { let p = JSON.parse(localVal); if(p && p._ts) lTs = p._ts; } } catch(x){}
                                    try { if(cloudVal) { let p = JSON.parse(cloudVal); if(p && p._ts) cTs = p._ts; } } catch(x){}
                                    
                                    if (lTs > cTs) {
                                        try { tg.CloudStorage.setItem(key, localVal); } catch(e) {}
                                        resolve(localVal);
                                    } else {
                                        try { localStorage.setItem(key, cloudVal); } catch(e) {}
                                        resolve(cloudVal);
                                    }
                                }
                            }
                        });
                    } catch (e) {
                        if(!resolved) { resolved = true; clearTimeout(fallback); resolve(localVal); }
                    }
                } else {
                    resolve(localVal);
                }
            });
        }
    };

    let balance = 0; let stats = { opened: 0, crafts: 0 }; let inventory = [];
    let isOpening = false; let currentPreviewCase = null; let lastWonItem = null; let multiWonItems = [];
    let openAmount = 1; let craftSelectedIds = []; let upgMyItem = null; let upgTargetItem = null;
    let isBonusMode = false; let isStandardCase = false; let currentWithdrawItemId = null;
    let userName = "–ò–≥—Ä–æ–∫"; let linkedRobloxAcc = null; let bindTargetUsername = "";
    let currentBindPhrase = ""; let bindTimerInt = null; let bindTimeLeft = 180;
    const bindWords = ['tree','auto','car','boom','cat','dog','sun','moon','star','fire','water','box','house','road','sky'];

    const genericSecretItem = { id: 'secret', type: 'item', icon: '‚ùì', image: '', name: '–°–µ–∫—Ä–µ—Ç–Ω—ã–π –¥—Ä–æ–ø', color: '#ffea00', price: 0, isSecret: true };

    const allItems = {
        'lux_jean': { id: 'lux_jean', type: 'item', name: '–î–∂–∏–Ω—Å–æ–≤–∫–∞ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#eb4b4b', image: 'https://i.postimg.cc/GtKWBQMT/IMAGE-2026-02-27-11-16-28.jpg', price: 1250000, weight: 0.1 },
        'lux_puff': { id: 'lux_puff', type: 'item', name: '–ß–µ—Ä–Ω—ã–π –ü—É—Ö–æ–≤–∏–∫ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#eb4b4b', image: 'https://i.postimg.cc/MGwm4SZw/IMAGE-2026-02-27-11-18-58.jpg', price: 1250000, weight: 0.1 },
        'lux_rab': { id: 'lux_rab', type: 'item', name: '–î–∂–∏–Ω—Å–æ–≤–∫–∞ –ö—Ä–æ–ª–∏–∫ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#eb4b4b', image: 'https://i.postimg.cc/bJ7xxcBT/IMAGE-2026-02-27-11-22-09.jpg', price: 600000, weight: 0.1 },
        'lux_rolex': { id: 'lux_rolex', type: 'item', name: '–ß–µ—Ä–Ω—ã–µ –†–æ–ª–µ–∫—Å—ã', color: '#ffea00', image: 'https://i.postimg.cc/XqGX5ynq/IMAGE-2026-02-28-15-53-56.jpg', price: 1500000, weight: 0.0001, isSecret: true },
        'lux_balen': { id: 'lux_balen', type: 'item', name: '–ë–µ–ª—ã–µ –û—á–∫–∏ –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞ "–ë—Ä–æ–≤—å"', color: '#ffea00', image: 'https://i.postimg.cc/RCyRqkBG/IMAGE-2026-02-28-15-55-03.jpg', price: 8000000, weight: 0.00001, isSecret: true },
        'lux_r1': { id: 'lux_r1', type: 'item', name: '–ë–∏–∑–Ω–µ—Å –ö–æ—Å—Ç—é–º –ü–µ—Ä—Ñ–µ–∫—Ç–æ', color: '#eb4b4b', image: 'https://i.postimg.cc/Z0kdd8C9/IMAGE-2026-02-27-11-20-22.jpg', price: 300000, weight: 3 },
        'lux_r2': { id: 'lux_r2', type: 'item', name: '–î–µ–ª–æ–≤–æ–π –ö–æ—Å—Ç—é–º', color: '#eb4b4b', image: 'https://i.postimg.cc/zXjhBgqr/IMAGE-2026-02-27-11-23-40.jpg', price: 300000, weight: 3 },
        'lux_b1': { id: 'lux_b1', type: 'item', name: '–ó–∞—Å—Ç. –•—É–¥–∏ –ú–µ–ª–ª—Å—Ç—Ä–æ—è', color: '#54a0ff', image: 'https://i.postimg.cc/0y4bMGFg/IMAGE-2026-02-27-11-25-00.jpg', price: 150000, weight: 10 },
        'lux_b2': { id: 'lux_b2', type: 'item', name: '–†–∞—Å—Å—Ç. –•—É–¥–∏ –ú–µ–ª–ª—Å—Ç—Ä–æ—è', color: '#54a0ff', image: 'https://i.postimg.cc/5N7tTqx2/IMAGE-2026-02-27-11-25-37.jpg', price: 150000, weight: 10 },
        'lux_b3': { id: 'lux_b3', type: 'item', name: '–ß–µ—Ä–Ω—ã–µ –®—Ç–∞–Ω—ã –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/XNZ3XS34/IMAGE-2026-02-27-11-29-30.jpg', price: 100000, weight: 10 },
        'lux_b4': { id: 'lux_b4', type: 'item', name: '–ë–µ–ª—ã–µ –®—Ç–∞–Ω—ã –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/4NkCdYB2/IMAGE-2026-02-27-11-30-19.jpg', price: 100000, weight: 10 },
        'lux_b5': { id: 'lux_b5', type: 'item', name: '–°–µ—Ä—ã–µ –®—Ç–∞–Ω—ã –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/ZKhgm15j/IMAGE-2026-02-27-11-30-59.jpg', price: 100000, weight: 10 },
        'lux_b6': { id: 'lux_b6', type: 'item', name: '–°–∏–Ω–µ–µ —Ö—É–¥–∏ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#54a0ff', image: 'https://i.postimg.cc/jS3ZD9R0/IMAGE-2026-02-27-11-32-01.jpg', price: 50000, weight: 14 },
        'lux_b7': { id: 'lux_b7', type: 'item', name: '–¢–∏–≥—Ä–æ–≤–æ–µ —Ö—É–¥–∏ –ì—É—á—á–∏', color: '#54a0ff', image: 'https://i.postimg.cc/25BFVSH5/IMAGE-2026-02-27-11-32-46.jpg', price: 80000, weight: 14 },
        'lux_b8': { id: 'lux_b8', type: 'item', name: '–ë–µ–ª–æ–µ –•—É–¥–∏ –õ—É–∏–í–∏—Ç–æ–Ω', color: '#54a0ff', image: 'https://i.postimg.cc/Ssf9M2cf/IMAGE-2026-02-27-11-33-46.jpg', price: 60000, weight: 15.69989 },

        'm1': { id: 'm1', type: 'money', name: '1 000 000 ‚ÇΩ', color: '#ffea00', price: 1000000, weight: 0.5, isSecret: true },
        'm2': { id: 'm2', type: 'money', name: '100 000 ‚ÇΩ', color: '#ff4757', price: 100000, weight: 2.5 },
        'm3': { id: 'm3', type: 'money', name: '50 000 ‚ÇΩ', color: '#54a0ff', price: 50000, weight: 7.5 },
        'm4': { id: 'm4', type: 'money', name: '30 000 ‚ÇΩ', color: '#b0c3d9', price: 30000, weight: 13 },
        'm5': { id: 'm5', type: 'money', name: '25 000 ‚ÇΩ', color: '#b0c3d9', price: 25000, weight: 18 },
        'm6': { id: 'm6', type: 'money', name: '15 000 ‚ÇΩ', color: '#b0c3d9', price: 15000, weight: 25.5 },
        'm7': { id: 'm7', type: 'money', name: '5 000 ‚ÇΩ', color: '#b0c3d9', price: 5000, weight: 33 },

        'agent_vatar': { id: 'agent_vatar', type: 'agent', name: '–ê–≥–µ–Ω—Ç Vatar', color: '#ffea00', image: 'https://i.postimg.cc/G3sVmJD2/IMAGE-2026-02-28-17-09-30.jpg', price: 0, weight: 0.001, isSecret: true, buffs: '–ë–∏–∑–Ω–µ—Å–º–µ–Ω: +3% –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.\n–ë–∞—Ä—ã–≥–∞: –°–∫–∏–¥–∫–∞ 5% –Ω–∞ –≤—Å–µ –∫–µ–π—Å—ã.' },
        'agent_zixxto': { id: 'agent_zixxto', type: 'agent', name: '–ê–≥–µ–Ω—Ç Zixxto', color: '#ffea00', image: 'https://i.postimg.cc/y85rKDNv/IMAGE-2026-02-28-17-19-34.jpg', price: 0, weight: 0.001, isSecret: true, buffs: '–ë–∏–∑–Ω–µ—Å–º–µ–Ω: +3% –ø—Ä–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞.\n–•–∞–∫–µ—Ä: –ü–æ–≤—ã—à–∞–µ—Ç —à–∞–Ω—Å –Ω–∞ –¥–æ—Ä–æ–≥–æ–π –¥—Ä–æ–ø.' },
        'agent_perfecto': { id: 'agent_perfecto', type: 'agent', name: '–ê–≥–µ–Ω—Ç Perfecto', color: '#ffea00', image: 'https://i.postimg.cc/XJN1Wm5n/IMAGE-2026-02-28-17-34-14.jpg', price: 0, weight: 0.001, isSecret: true, buffs: '–ü—Ä–æ–¥–∞–≤–µ—Ü: +10% –∫ –±–∞–ª–∞–Ω—Å—É –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ.\n–£–¥–∞—á–∞: –£–ª—É—á—à–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤.' },
        'agent_vovan': { id: 'agent_vovan', type: 'agent', name: '–ê–≥–µ–Ω—Ç Vovan', color: '#ffea00', icon: 'üïµÔ∏è‚Äç‚ôÇÔ∏è', image: '', price: 0, weight: 0.001, isSecret: true, buffs: '–õ—É–¥–æ–º–∞–Ω: +6% —à–∞–Ω—Å –≤ –ê–ø–≥—Ä–µ–π–¥–µ –∏ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–µ.' },
        'agent_cheba': { id: 'agent_cheba', type: 'agent', name: '–ê–≥–µ–Ω—Ç –ß–µ–±–∞', color: '#eb4b4b', image: 'https://i.postimg.cc/YC5f8VRV/IMAGE-2026-02-28-17-53-28.jpg', price: 0, weight: 0.1, buffs: '–£–¥–∞—á–∞: +5% —à–∞–Ω—Å –≤—ã–∏–≥—Ä–∞—Ç—å –≤ –ê–ø–≥—Ä–µ–π–¥–µ.' },
        'agent_funky': { id: 'agent_funky', type: 'agent', name: '–ê–≥–µ–Ω—Ç Funky', color: '#eb4b4b', image: 'https://i.postimg.cc/6pfnL37j/IMAGE-2026-02-28-17-59-22.jpg', price: 0, weight: 0.1, buffs: '–°—Ç—Ä–æ–∏—Ç–µ–ª—å: +5% —à–∞–Ω—Å –≤—ã–∏–≥—Ä–∞—Ç—å –≤ –ê–ø–≥—Ä–µ–π–¥–µ.' },
        'agent_pechen': { id: 'agent_pechen', type: 'agent', name: '–ê–≥–µ–Ω—Ç Pechen', color: '#eb4b4b', image: 'https://i.postimg.cc/D0SPxTVm/IMAGE-2026-02-28-18-11-59.jpg', price: 0, weight: 35, buffs: '–£–¥–∞—á–∞: +5% —à–∞–Ω—Å –≤—ã–∏–≥—Ä–∞—Ç—å –≤ –ê–ø–≥—Ä–µ–π–¥–µ.' },
        'agent_150k': { id: 'agent_150k', type: 'money', name: '–ö—ç—à–±—ç–∫ 150 000 ‚ÇΩ', color: '#b0c3d9', price: 150000, weight: 64.796 },

        'opium_key': { id: 'opium_key', type: 'key', name: '–ö–ª—é—á –û–ø–∏—É–º', color: '#ffea00', price: 50000, image: 'https://i.postimg.cc/TwBPtkP2/IMAGE-2026-03-01-12-15-31.jpg' },
        'op_mask': { id: 'op_mask', type: 'item', name: '–ú–∞—Å–∫–∞ –ü—è—Ç–Ω–∏—Ü–∞ 13', color: '#ffea00', image: 'https://i.postimg.cc/cHtxtQB5/IMAGE-2026-03-01-12-17-04.jpg', price: 10000000, weight: 0.001, isSecret: true },
        'op_snow': { id: 'op_snow', type: 'item', name: '–°–Ω–æ—É–±–æ—Ä–¥ –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#ffea00', image: 'https://i.postimg.cc/YShkT1Zj/IMAGE-2026-03-01-12-18-33.jpg', price: 10000000, weight: 0.001, isSecret: true },
        'op_shirt': { id: 'op_shirt', type: 'item', name: '–†—É–±–∞—à–∫–∞ –õ–µ–π—Å –†–∏–∫–æ–≤–µ–Ω—Å', color: '#ffea00', image: 'https://i.postimg.cc/t4mGdsT3/IMAGE-2026-03-01-12-19-49.jpg', price: 8000000, weight: 0.01, isSecret: true },
        'op_m1': { id: 'op_m1', type: 'money', name: '–ë–æ–Ω—É—Å 400 000 ‚ÇΩ', color: '#eb4b4b', price: 400000, weight: 1 },
        'op_m2': { id: 'op_m2', type: 'money', name: '–ë–æ–Ω—É—Å 250 000 ‚ÇΩ', color: '#eb4b4b', price: 250000, weight: 25 },
        'op_m3': { id: 'op_m3', type: 'money', name: '–ë–æ–Ω—É—Å 200 000 ‚ÇΩ', color: '#eb4b4b', price: 200000, weight: 30 },
        'op_m4': { id: 'op_m4', type: 'money', name: '–ë–æ–Ω—É—Å 150 000 ‚ÇΩ', color: '#eb4b4b', price: 150000, weight: 40 },
        'op_puff': { id: 'op_puff', type: 'item', name: '–ü—É—Ö–æ–≤–∏–∫ –†–∏–∫', color: '#54a0ff', image: 'https://i.postimg.cc/kMjsgKpd/IMAGE-2026-03-01-12-24-27.jpg', price: 160000, weight: 37 },
        'op_p1': { id: 'op_p1', type: 'item', name: '–®—Ç–∞–Ω—ã –ß–∏–≥—É—Ä–∞ –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#b0c3d9', image: 'https://i.postimg.cc/FsMjYZbg/IMAGE-2026-03-01-12-26-05.jpg', price: 30000, weight: 45 },
        'op_p2': { id: 'op_p2', type: 'item', name: '–ü–æ—Ç—Ä–µ–ø–∞–Ω–Ω—ã–µ –®—Ç–∞–Ω—ã –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#b0c3d9', image: 'https://i.postimg.cc/rpQ0NC4Q/IMAGE-2026-03-01-12-28-00.jpg', price: 25000, weight: 47 },
        'op_p3': { id: 'op_p3', type: 'item', name: '–õ–∏–Ω–µ–π–Ω—ã–µ –®—Ç–∞–Ω—ã –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#b0c3d9', image: 'https://i.postimg.cc/KvPngT0V/IMAGE-2026-03-01-12-29-48.jpg', price: 30000, weight: 45 },
        'op_j1': { id: 'op_j1', type: 'item', name: '–°–∏–Ω—è—è –î–∂–∏–Ω—Å–æ–≤–∫–∞ –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#b0c3d9', image: 'https://i.postimg.cc/fRQBGZPm/IMAGE-2026-03-01-12-39_32.jpg', price: 150000, weight: 42 },
        'op_j2': { id: 'op_j2', type: 'item', name: '–î–∂–∏–Ω—Å. –ì—Ä–∞—Ñ—Ñ–∏—Ç–∏ –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#b0c3d9', image: 'https://i.postimg.cc/ZRQLVh3h/IMAGE-2026-03-01-12-40_23.jpg', price: 130000, weight: 48 },
        'op_h1': { id: 'op_h1', type: 'item', name: '–•—É–¥–∏ –ü–∞—Ä–∏–∂ –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#b0c3d9', image: 'https://i.postimg.cc/8kJ8DpZM/IMAGE-2026-03-01-12-40-59.jpg', price: 50000, weight: 55 },
        'op_t1': { id: 'op_t1', type: 'item', name: '–ë–µ–ª–∞—è –§—É—Ç–±–æ–ª–∫–∞ –ë–∞–ª–µ–Ω—Å–∏–∞–≥–∞', color: '#b0c3d9', image: 'https://i.postimg.cc/BnCkNXnm/IMAGE-2026-03-01-12-41-35.jpg', price: 30000, weight: 60 },

        'md_key': { id: 'md_key', type: 'key', name: '–ö–ª—é—á –ú–æ–¥–Ω—ã–π –î–æ–º', color: '#ffea00', price: 50000, image: 'https://i.postimg.cc/fy94j95x/IMAGE-2026-03-01-16-18-35.jpg' },
        'md_sec1': { id: 'md_sec1', type: 'item', name: '–°–≤–∏—Ç–µ—Ä –ú–æ—Ö–µ—Ä Undercover', color: '#ffea00', image: 'https://i.postimg.cc/fb9gPNY9/IMAGE-2026-03-01-16-23-49.jpg', price: 20000000, weight: 0.0001, isSecret: true },
        'md_sec2': { id: 'md_sec2', type: 'item', name: '–ö–æ—Ä–∏—á–Ω. –§—É—Ç–±. Maison Margiela', color: '#ffea00', image: 'https://i.postimg.cc/mk2jTf1R/IMAGE-2026-03-01-16-25-17.jpg', price: 15000000, weight: 0.0001, isSecret: true },
        'md_m1': { id: 'md_m1', type: 'money', name: '–ë–æ–Ω—É—Å 1 000 000 ‚ÇΩ', color: '#eb4b4b', price: 1000000, weight: 0.1 },
        'md_m2': { id: 'md_m2', type: 'money', name: '–ë–æ–Ω—É—Å 500 000 ‚ÇΩ', color: '#eb4b4b', price: 500000, weight: 0.3 },
        'md_m3': { id: 'md_m3', type: 'money', name: '–ë–æ–Ω—É—Å 300 000 ‚ÇΩ', color: '#eb4b4b', price: 300000, weight: 1 },
        'md_m4': { id: 'md_m4', type: 'money', name: '–ë–æ–Ω—É—Å 250 000 ‚ÇΩ', color: '#eb4b4b', price: 250000, weight: 8 },
        'md_m5': { id: 'md_m5', type: 'money', name: '–ë–æ–Ω—É—Å 200 000 ‚ÇΩ', color: '#eb4b4b', price: 200000, weight: 15 },
        'md_m6': { id: 'md_m6', type: 'money', name: '–ë–æ–Ω—É—Å 150 000 ‚ÇΩ', color: '#eb4b4b', price: 150000, weight: 20 },
        'md_i1': { id: 'md_i1', type: 'item', name: '–•—É–¥–∏ –ß–µ—Ä–µ–ø', color: '#b0c3d9', image: 'https://i.postimg.cc/434xbsqZ/IMAGE-2026-03-01-16-57-46.jpg', price: 55000, weight: 50 },
        'md_i2': { id: 'md_i2', type: 'item', name: '–ö–æ—Ä–∏—á–Ω–µ–≤–æ–µ –•—É–¥–∏ –ê–Ω–¥–µ—Ä', color: '#b0c3d9', image: 'https://i.postimg.cc/hPF4Z96d/IMAGE-2026-03-01-16-58-21.jpg', price: 60000, weight: 50 },
        'md_i3': { id: 'md_i3', type: 'item', name: '–ß–µ—Ä–Ω. –§—É—Ç–±–æ–ª–∫–∞ –ê–Ω–¥–µ—Ä–ö–∞–≤–µ—Ä', color: '#b0c3d9', image: 'https://i.postimg.cc/xd7VJQSb/IMAGE-2026-03-01-16-59-47.jpg', price: 45000, weight: 55 },
        'md_i4': { id: 'md_i4', type: 'item', name: '–°–∏–Ω–µ–µ –•—É–¥–∏ –ê–Ω–¥–µ—Ä "–†–∞–¥–∞—Ä"', color: '#b0c3d9', image: 'https://i.postimg.cc/d0hzKfTJ/IMAGE-2026-03-01-17-00-32.jpg', price: 60000, weight: 45 },
        'md_i5': { id: 'md_i5', type: 'item', name: '–ß–µ—Ä–Ω. –§—É—Ç–±–æ–ª–∫–∞ "–Ø–±–ª–æ–∫–æ"', color: '#b0c3d9', image: 'https://i.postimg.cc/DwZNqN6x/IMAGE-2026-03-01-17-01-18.jpg', price: 55000, weight: 50 },
        'md_i6': { id: 'md_i6', type: 'item', name: '–ß–µ—Ä–Ω. –§—É—Ç–±. –ª–æ–≥–æ –ê–Ω–¥–µ—Ä–ö–∞–≤–µ—Ä', color: '#b0c3d9', image: 'https://i.postimg.cc/tRNv8bm2/IMAGE-2026-03-01-17-01-56.jpg', price: 45000, weight: 60 },
        'md_i7': { id: 'md_i7', type: 'item', name: '–ß–µ—Ä–Ω–∞—è –§—É—Ç–±–æ–ª–∫–∞ –ê–Ω–¥–µ—Ä', color: '#b0c3d9', image: 'https://i.postimg.cc/cHMTq7Tt/IMAGE-2026-03-01-17-02-38.jpg', price: 50000, weight: 55 },
        'md_i8': { id: 'md_i8', type: 'item', name: '–ë–µ–ª–∞—è –§—É—Ç–±–æ–ª–∫–∞ –ê–Ω–¥–µ—Ä "–ö–æ—Å—Ç–∏"', color: '#b0c3d9', image: 'https://i.postimg.cc/0QfGXk2j/IMAGE-2026-03-01-17-03-22.jpg', price: 50000, weight: 55 },
        'md_i9': { id: 'md_i9', type: 'item', name: '–°–∏–Ω—è—è –§—É—Ç–±. –° –ì—É–±–∫–æ–π –ê–Ω–¥–µ—Ä', color: '#b0c3d9', image: 'https://i.postimg.cc/yNCFVgDj/IMAGE-2026-03-01-17-04-37.jpg', price: 45000, weight: 60 },
        'md_i10': { id: 'md_i10', type: 'item', name: '–°–∏–Ω–∏–µ –¥–∂–∏–Ω—Å—ã –ê–Ω–¥–µ—Ä', color: '#b0c3d9', image: 'https://i.postimg.cc/YS7m55PQ/IMAGE-2026-03-01-17-05-26.jpg', price: 45000, weight: 60 },
        'md_i11': { id: 'md_i11', type: 'item', name: '–ë–µ–ª–∞—è –†—É–±–∞—à–∫–∞ –ê–Ω–¥–µ—Ä', color: '#b0c3d9', image: 'https://i.postimg.cc/65jKJn1C/IMAGE-2026-03-01-17-13-30.jpg', price: 50000, weight: 55 }
    };

    const casesData = [
        { id: 'money_case', name: '–î–µ–Ω–µ–∂–Ω—ã–π –ö–µ–π—Å', image: 'https://i.postimg.cc/CLCgq1VJ/2026-02-27-09-01-01.jpg', price: 30000, drops: ['m1', 'm2', 'm3', 'm4', 'm5', 'm6', 'm7'] },
        { id: 'lux_case', name: '–ö–µ–π—Å –õ—é–∫—Å', image: 'https://i.postimg.cc/3NjKtmt7/IMAGE-2026-02-27-11-14-36.jpg', price: 150000, drops: ['lux_jean', 'lux_puff', 'lux_rab', 'lux_r1', 'lux_r2', 'lux_b1', 'lux_b2', 'lux_b3', 'lux_b4', 'lux_b5', 'lux_b6', 'lux_b7', 'lux_b8', 'lux_rolex', 'lux_balen'] },
        { id: 'opium_case', name: '–ö–µ–π—Å –û–ø–∏—É–º', requiredKey: 'opium_key', image: 'https://i.postimg.cc/MG4VVmVF/IMAGE-2026-03-01-11-58-15.jpg', price: 150000, drops: ['op_mask', 'op_snow', 'op_shirt', 'op_m1', 'op_m2', 'op_m3', 'op_m4', 'op_puff', 'op_p1', 'op_p2', 'op_p3', 'op_j1', 'op_j2', 'op_h1', 'op_t1'] },
        { id: 'md_case', name: '–ö–µ–π—Å –ú–æ–¥–Ω—ã–π –î–æ–º', requiredKey: 'md_key', image: 'https://i.postimg.cc/tg3YDsvs/IMAGE-2026-03-01-16-14-38.jpg', price: 100000, drops: ['md_sec1', 'md_sec2', 'md_m1', 'md_m2', 'md_m3', 'md_m4', 'md_m5', 'md_m6', 'md_i1', 'md_i2', 'md_i3', 'md_i4', 'md_i5', 'md_i6', 'md_i7', 'md_i8', 'md_i9', 'md_i10', 'md_i11'] },
        { id: 'agent_case', name: '–î–æ—Å—å–µ –ê–≥–µ–Ω—Ç–æ–≤', image: 'https://i.postimg.cc/fbjWQ4sR/IMAGE_2026_02_28_10_06_11.jpg', price: 1000000, drops: ['agent_vatar', 'agent_zixxto', 'agent_perfecto', 'agent_vovan', 'agent_cheba', 'agent_funky', 'agent_pechen', 'agent_150k'] }
    ];

    const keysData = [
        { id: 'opium_key', name: '–ö–ª—é—á –û–ø–∏—É–º', price: 50000, image: 'https://i.postimg.cc/TwBPtkP2/IMAGE-2026-03-01-12-15-31.jpg' },
        { id: 'md_key', name: '–ö–ª—é—á –ú–æ–¥–Ω—ã–π –î–æ–º', price: 50000, image: 'https://i.postimg.cc/fy94j95x/IMAGE-2026-03-01-16-18-35.jpg' }
    ];

    function updateProfileUI() {
        const statusDiv = document.getElementById('robloxLinkedStatus');
        if (linkedRobloxAcc) {
            statusDiv.innerHTML = `
                <div style="background: rgba(0, 184, 148, 0.1); border: 1px solid rgba(0, 184, 148, 0.3); padding: 12px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="font-weight: bold; color: white;">‚úÖ ${linkedRobloxAcc}</div>
                    <div style="font-size: 11px; color: #00b894; background: rgba(0, 184, 148, 0.2); padding: 4px 8px; border-radius: 6px;">–ü—Ä–∏–≤—è–∑–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞</div>
                </div>
            `;
        }
    }

    function openBindModal() {
        document.getElementById('bindUsernameInput').value = '';
        document.getElementById('bindStep1').style.display = 'block';
        document.getElementById('bindStep2').style.display = 'none';
        openModal('bindModal');
    }

    function closeBindModal() { clearInterval(bindTimerInt); closeModal('bindModal'); }

    function goToBindStep2() {
        let nick = document.getElementById('bindUsernameInput').value.trim();
        if (!/^[a-zA-Z0-9_]{3,20}$/.test(nick)) { alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–∏–∫ Roblox!'); return; }
        bindTargetUsername = nick;
        currentBindPhrase = `${bindWords[Math.floor(Math.random()*bindWords.length)]}-${bindWords[Math.floor(Math.random()*bindWords.length)]}-${bindWords[Math.floor(Math.random()*bindWords.length)]}-${bindWords[Math.floor(Math.random()*bindWords.length)]}`;
        document.getElementById('bindPhraseDisplay').innerText = currentBindPhrase;
        document.getElementById('bindStep1').style.display = 'none';
        document.getElementById('bindStep2').style.display = 'block';
        bindTimeLeft = 180; updateBindTimer(); clearInterval(bindTimerInt);
        bindTimerInt = setInterval(() => { bindTimeLeft--; updateBindTimer(); if (bindTimeLeft <= 0) { clearInterval(bindTimerInt); alert("–í—Ä–µ–º—è –≤—ã—à–ª–æ! –ù–∞—á–Ω–∏—Ç–µ –ø—Ä–∏–≤—è–∑–∫—É –∑–∞–Ω–æ–≤–æ."); closeBindModal(); } }, 1000);
    }

    function updateBindTimer() {
        let m = Math.floor(bindTimeLeft / 60); let s = bindTimeLeft % 60;
        document.getElementById('bindTimerDisplay').innerText = `0${m}:${s < 10 ? '0'+s : s}`;
    }

    async function verifyRobloxAcc() {
        const btn = document.getElementById('btnVerifyRoblox'); btn.disabled = true; btn.innerText = '–ü—Ä–æ–≤–µ—Ä–∫–∞... (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 10-20 —Å–µ–∫)';
        try {
            const urls = ['https://users.roproxy.com/v1/usernames/users', 'https://corsproxy.io/?https://users.roblox.com/v1/usernames/users'];
            let userId = null;
            for (let url of urls) {
                try {
                    let r = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify({ usernames: [bindTargetUsername], excludeBannedUsers: true }) });
                    if (r.ok) { let d = await r.json(); if (d.data && d.data.length > 0) { userId = d.data[0].id; break; } }
                } catch(e) {}
            }
            if (!userId) { alert('–°–±–æ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏ Roblox –∏–ª–∏ –Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!'); btn.disabled = false; btn.innerText = '–Ø —É–∫–∞–∑–∞–ª —Ñ—Ä–∞–∑—É'; return; }

            const descUrls = [`https://users.roproxy.com/v1/users/${userId}`, `https://corsproxy.io/?https://users.roblox.com/v1/users/${userId}`];
            let desc = null;
            for (let url of descUrls) {
                try { let r = await fetch(url); if (r.ok) { let d = await r.json(); desc = d.description || ""; break; } } catch(e) {}
            }

            if (desc !== null && desc.includes(currentBindPhrase)) {
                linkedRobloxAcc = bindTargetUsername; saveAllData(); alert('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω!'); closeBindModal(); updateProfileUI();
            } else {
                alert('‚ùå –§—Ä–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è! –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –≤ Roblox, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –µ—â–µ —Ä–∞–∑.');
                btn.disabled = false; btn.innerText = '–Ø —É–∫–∞–∑–∞–ª —Ñ—Ä–∞–∑—É';
            }
        } catch (err) { alert('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'); btn.disabled = false; btn.innerText = '–Ø —É–∫–∞–∑–∞–ª —Ñ—Ä–∞–∑—É'; }
    }

    function hasAgent(agentId) { return inventory.some(i => i.id === agentId); }
    function getAnyAgent() { return inventory.find(i => i.type === 'agent'); }
    function getCasePrice(caseObj) { let p = caseObj.price; if (hasAgent('agent_vatar')) p = Math.floor(p * 0.95); return p; }

    function updateAgentStatus() {
        let activeAgent = getAnyAgent();
        if (activeAgent) { document.getElementById('tgUserStatus').innerText = activeAgent.name; document.getElementById('tgUserStatus').style.color = activeAgent.color; } 
        else { document.getElementById('tgUserStatus').innerText = '–ù–æ–≤–∏—á–æ–∫'; document.getElementById('tgUserStatus').style.color = '#8b8b99'; }
    }

    function fireAgent(invId, name) {
        if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–≤–æ–ª–∏—Ç—å ${name}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å, –∏ –∞–≥–µ–Ω—Ç –∏—Å—á–µ–∑–Ω–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞.`)) {
            inventory = inventory.filter(i => String(i.invId) !== String(invId));
            saveAllData(); renderInventory(); updateAgentStatus(); alert(`${name} —É—Å–ø–µ—à–Ω–æ —É–≤–æ–ª–µ–Ω!`);
        }
    }

    function saveAllData() {
        try {
            const data = { balance: balance, stats: stats, linkedAcc: linkedRobloxAcc, inventory: inventory.map(i => ({ id: i.id, invId: String(i.invId), price: i.price })) };
            db.save('roblox_save_v2', JSON.stringify(data));
        } catch(e) {}
    }

    function updateBalanceUI() { document.getElementById('balanceAmount').innerText = balance.toLocaleString('ru-RU'); saveAllData(); }

    function getWeightedRandomItem(dropList, isZixxtoActive = false) {
        let list = dropList;
        if (isZixxtoActive && Math.random() < 0.2) { 
            list = dropList.map(item => { let w = item.weight || 1; if (item.isSecret || item.color === '#eb4b4b') w *= 5; return { ...item, weight: w }; });
        }
        let totalWeight = list.reduce((sum, item) => sum + (item.weight || 1), 0);
        let random = Math.random() * totalWeight;
        for (let i = 0; i < list.length; i++) {
            if (random < (list[i].weight || 1)) return dropList[i];
            random -= (list[i].weight || 1);
        }
        return dropList[0];
    }

    function renderItemIcon(item, isTape = false) {
        if (!item) return '?';
        if (item.isSecret && item.image && item.id !== 'secret') {
            if (isTape) return `<div style="font-size:40px; color:${item.color || '#ffea00'}; filter: drop-shadow(0 0 10px ${item.color || '#ffea00'})">‚ùì</div>`;
            return `<img src="${item.image}" alt="Secret" style="border-radius:12px; border: 2px solid ${item.color || '#ffea00'}; box-shadow: 0 0 15px ${item.color || '#ffea00'};">`;
        }
        if (isTape && item.isSecret) return `<div style="font-size:40px; color:${item.color || '#ffea00'}; filter: drop-shadow(0 0 10px ${item.color || '#ffea00'})">‚ùì</div>`;
        if (item.type === 'money' && isTape) return `<div style="font-size: 16px; font-weight: 800; color:${item.color}">${(item.price || 0).toLocaleString('ru-RU')} ‚ÇΩ</div>`;
        if (item.image && item.image !== '') return `<img src="${item.image}" alt="${item.name}">`;
        if (item.icon) return `<div style="font-size:40px;">${item.icon}</div>`;
        if (item.type === 'money') return `<div style="font-size:30px;">üíµ</div>`;
        return '‚ùì';
    }

    window.onload = async () => {
        let initial = "–ò";
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            let u = tg.initDataUnsafe.user; if (u.username) userName = "@" + u.username; else userName = u.first_name || u.id.toString(); initial = userName.replace('@', '').charAt(0).toUpperCase();
        }
        
        try {
            let v2Save = await db.load('roblox_save_v2');
            if (v2Save && v2Save !== 'null') {
                let parsed = JSON.parse(v2Save);
                balance = parsed.balance || 0; stats = parsed.stats || { opened: 0, crafts: 0 }; linkedRobloxAcc = parsed.linkedAcc || null;
                inventory = (parsed.inventory || []).map(m => { let baseItem = allItems[m.id]; if (baseItem) return { ...baseItem, invId: String(m.invId), price: m.price || baseItem.price || 0 }; return null; }).filter(i => i !== null);
            } else {
                let oldLinked = await db.load('roblox_linked_acc'); if (oldLinked && oldLinked !== 'null') linkedRobloxAcc = oldLinked;
                let oldBal = await db.load('roblox_balance'); balance = oldBal !== null ? parseInt(oldBal) : 1500;
                let oldInv = await db.load('roblox_inv');
                if (oldInv && oldInv !== 'null') { inventory = JSON.parse(oldInv).map(m => { let baseItem = allItems[m.id]; if (baseItem) return { ...baseItem, invId: String(m.invId), price: m.price || baseItem.price || 0 }; return null; }).filter(i => i !== null); }
                let oldStats = await db.load('roblox_stats'); if (oldStats && oldStats !== 'null') stats = JSON.parse(oldStats);
                saveAllData(); 
            }
        } catch (err) {
            balance = 1500; inventory = []; stats = { opened: 0, crafts: 0 }; saveAllData();
        }
        
        updateProfileUI();

        let pendingStr = await db.load('pending_claim');
        if (pendingStr && pendingStr !== 'null') {
            try {
                let pendingItem = JSON.parse(pendingStr);
                if (pendingItem.type === 'money') { balance += pendingItem.price || 0; tg.showAlert(`–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è! –í–∞—à –≤—ã–∏–≥—Ä—ã—à (${pendingItem.name}) –±—ã–ª –∑–∞—á–∏—Å–ª–µ–Ω –Ω–∞ –±–∞–ª–∞–Ω—Å.`); }
                else if (pendingItem.type === 'item' || pendingItem.type === 'agent') { inventory.push({ ...pendingItem, invId: String(Date.now() + Math.random()) }); tg.showAlert(`–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è! –ü—Ä–µ–¥–º–µ—Ç "${pendingItem.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.`); }
                else if (pendingItem.type === 'fail') { tg.showAlert(`–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É –≤–æ –≤—Ä–µ–º—è –ê–ø–≥—Ä–µ–π–¥–∞! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —à–∞–Ω—Å –Ω–µ —Å—ã–≥—Ä–∞–ª –∏ –≤–∞—à –ø—Ä–µ–¥–º–µ—Ç —Å–≥–æ—Ä–µ–ª.`); }
                db.save('pending_claim', 'null'); saveAllData();
            } catch (e) { db.save('pending_claim', 'null'); }
        }

        let pendingMultiStr = await db.load('pending_claim_multi');
        if (pendingMultiStr && pendingMultiStr !== 'null') {
            try {
                let items = JSON.parse(pendingMultiStr); let moneyAdded = 0; let itemsAdded = 0;
                items.forEach(item => { if (item.type === 'money') moneyAdded += item.price; else if (item.type !== 'promo') { inventory.push({...item, invId: String(Date.now()+Math.random())}); itemsAdded++; } });
                balance += moneyAdded; tg.showAlert(`–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∏–≥—Ä—É –≤–æ –≤—Ä–µ–º—è –º—É–ª—å—Ç–∏-–æ—Ç–∫—Ä—ã—Ç–∏—è! –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: ${itemsAdded} –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ ${moneyAdded.toLocaleString('ru-RU')} ‚ÇΩ.`);
                db.save('pending_claim_multi', 'null'); saveAllData();
            } catch(e) { db.save('pending_claim_multi', 'null'); }
        }

        const urlParams = new URLSearchParams(window.location.search);
        let topupAmount = urlParams.get('topup_amount'); let topupId = urlParams.get('topup_id');
        if (topupAmount && topupId) {
            let pStr = await db.load('processed_topups'); let processedTopups = pStr ? JSON.parse(pStr) : [];
            if (!processedTopups.includes(topupId)) {
                let finalAdd = parseInt(topupAmount);
                if (hasAgent('agent_vatar') || hasAgent('agent_zixxto')) { let bonus = Math.floor(finalAdd * 0.03); finalAdd += bonus; tg.showAlert(`–ë–æ–Ω—É—Å –æ—Ç –ê–≥–µ–Ω—Ç–∞! –í–∞–º –∑–∞—á–∏—Å–ª–µ–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ +${bonus.toLocaleString('ru-RU')} ‚ÇΩ (–ò—Ç–æ–≥–æ: ${finalAdd.toLocaleString('ru-RU')} ‚ÇΩ)`); }
                else { tg.showAlert(`‚úÖ –í–∞—à –±–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ ${finalAdd.toLocaleString('ru-RU')} ‚ÇΩ!`); }
                balance += finalAdd; processedTopups.push(topupId); db.save('processed_topups', JSON.stringify(processedTopups)); saveAllData();
            }
            const url = new URL(window.location); url.searchParams.delete('topup_amount'); url.searchParams.delete('topup_id'); window.history.replaceState({}, document.title, url);
        }
        
        let ungiveAmount = urlParams.get('ungive_amount'); let ungiveId = urlParams.get('ungive_id');
        if (ungiveAmount && ungiveId) {
            let uStr = await db.load('processed_ungives'); let processedUngives = uStr ? JSON.parse(uStr) : [];
            if (!processedUngives.includes(ungiveId)) {
                let deduct = parseInt(ungiveAmount); balance -= deduct; if (balance < 0) balance = 0;
                processedUngives.push(ungiveId); db.save('processed_ungives', JSON.stringify(processedUngives));
                tg.showAlert(`‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–ø–∏—Å–∞–ª —Å –≤–∞—à–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ ${deduct.toLocaleString('ru-RU')} ‚ÇΩ.\n–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${balance.toLocaleString('ru-RU')} ‚ÇΩ`); saveAllData();
            }
            const url = new URL(window.location); url.searchParams.delete('ungive_amount'); url.searchParams.delete('ungive_id'); window.history.replaceState({}, document.title, url);
        }

        document.getElementById('tgUserName').innerText = userName; document.getElementById('userAvatar').innerText = initial; document.getElementById('refLink').innerText = `t.me/StockOGCasesBot?start=ref${tg.initDataUnsafe?.user?.id || '123'}`; updateAgentStatus();

        let returnItemId = urlParams.get('return_item'); let returnToken = urlParams.get('t');
        if (returnItemId && returnToken) {
            let pRetStr = await db.load('processed_returns'); let processedReturns = pRetStr ? JSON.parse(pRetStr) : [];
            if (!processedReturns.includes(returnToken)) {
                let itemToReturn = allItems[returnItemId];
                if (itemToReturn) { inventory.push({ ...itemToReturn, invId: String(Date.now() + Math.random()), price: itemToReturn.price }); saveAllData(); processedReturns.push(returnToken); db.save('processed_returns', JSON.stringify(processedReturns)); tg.showAlert(`–ü—Ä–µ–¥–º–µ—Ç "${itemToReturn.name}" —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!`); }
            }
            const url = new URL(window.location); url.searchParams.delete('return_item'); url.searchParams.delete('t'); window.history.replaceState({}, document.title, url);
        }

        renderCases(); renderKeys(); updateBalanceUI(); updateBonusButton();
    };

    function startTopupProcess() { alert('–î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∑–∞–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å" –≤ –º–µ–Ω—é –±–æ—Ç–∞!'); tg.close(); }

    function switchPage(pageId, btnElement) {
        if (isOpening) return; document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById('page-' + pageId).classList.add('active');
        if (btnElement) { document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); btnElement.classList.add('active'); }
        if(pageId === 'inventory') renderInventory(); if(pageId === 'games') { renderCraftInventory(); updateUpgUI(); } if(pageId === 'bonus') updateBonusButton();
    }

    function switchShopTab(tabId) {
        document.getElementById('casesGrid').style.display = tabId === 'cases' ? 'grid' : 'none';
        document.getElementById('keysGrid').style.display = tabId === 'keys' ? 'grid' : 'none';
        document.getElementById('btnTabCases').classList.replace(tabId === 'cases' ? 'btn-outline' : 'btn', tabId === 'cases' ? 'btn' : 'btn-outline');
        document.getElementById('btnTabKeys').classList.replace(tabId === 'keys' ? 'btn-outline' : 'btn', tabId === 'keys' ? 'btn' : 'btn-outline');
    }

    function switchGameTab(tabId) {
        if (isOpening) return; document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active')); document.getElementById('tab-' + tabId).classList.add('active');
        document.getElementById('btnTabContract').classList.replace('btn', 'btn-outline'); document.getElementById('btnTabUpgrade').classList.replace('btn', 'btn-outline');
        if (tabId === 'contract') { document.getElementById('btnTabContract').classList.replace('btn-outline', 'btn'); renderCraftInventory(); } else if (tabId === 'upgrade') { document.getElementById('btnTabUpgrade').classList.replace('btn-outline', 'btn'); updateUpgUI(); }
    }

    async function updateBonusButton() {
        const btn = document.getElementById('btnBonusSpin'); if (!btn) return false;
        const lastSpin = await db.load('lastBonusSpin'); if (lastSpin) { const diff = Date.now() - parseInt(lastSpin); if (diff < 86400000) { btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; btn.innerText = '–î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–≤—Ç—Ä–∞'; return false; } }
        btn.style.opacity = '1'; btn.style.cursor = 'pointer'; btn.innerText = '–ö—Ä—É—Ç–∏—Ç—å (–ë–µ—Å–ø–ª–∞—Ç–Ω–æ)'; return true;
    }

    function spinBonusWheel() {
        if (isOpening) return; const btn = document.getElementById('btnBonusSpin'); if (btn.innerText === '–î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–≤—Ç—Ä–∞') return;
        isOpening = true; isBonusMode = true; isStandardCase = false;
        document.getElementById('page-bonus').classList.remove('active'); document.getElementById('page-roulette').classList.add('active'); document.getElementById('openingCaseName').innerText = "–ö–æ–ª–µ—Å–æ —É–¥–∞—á–∏..."; document.getElementById('roulette').style.display = 'block';
        const container = document.getElementById('rouletteItems'); container.innerHTML = ''; const roll = Math.random() * 100;
        if (roll <= 30) lastWonItem = { type: 'promo', icon: 'üéüÔ∏è', name: '–ü—Ä–æ–º–æ–∫–æ–¥ +5%', color: '#0984e3' }; else lastWonItem = { type: 'nothing', icon: 'üí®', name: '–ú–∏–º–æ', color: '#8b8b99' };
        const bonusDisplayItems = [ { type: 'promo', icon: 'üéüÔ∏è', name: '–ü—Ä–æ–º–æ–∫–æ–¥ +5%', color: '#0984e3' }, { type: 'nothing', icon: 'üí®', name: '–ú–∏–º–æ', color: '#8b8b99' }, { type: 'nothing', icon: 'üí©', name: '–ù–∏—á–µ–≥–æ', color: '#8b8b99' } ];
        initRoulette(bonusDisplayItems); db.save('lastBonusSpin', Date.now().toString()); runRouletteAnimation(lastWonItem, () => { if (lastWonItem.type === 'promo') showResultModal('–£–¥–∞—á–∞ –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ!'); else showResultModal('–ù–µ –ø–æ–≤–µ–∑–ª–æ...'); });
    }

    function renderCases() {
        const grid = document.getElementById('casesGrid'); grid.innerHTML = '';
        casesData.forEach(c => {
            let finalPrice = getCasePrice(c); const displayImg = c.image ? `<img src="${c.image}" style="width:100%; height:100%;">` : `<div style="font-size:60px;">${c.icon}</div>`;
            let priceHTML = `<div class="case-card-price">${finalPrice.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            if (finalPrice < c.price) priceHTML = `<div class="case-card-price" style="background:rgba(0,184,148,0.15); color:#00b894;"><del style="color:#8b8b99; font-size:11px;">${c.price}</del> ${finalPrice.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            grid.innerHTML += `<div class="case-card" onclick="openCasePreview('${c.id}')"><div class="case-card-img">${displayImg}</div><div class="case-card-title">${c.name}</div>${priceHTML}</div>`;
        });
    }

    function renderKeys() {
        const grid = document.getElementById('keysGrid'); grid.innerHTML = '';
        if (keysData.length === 0) { grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8b8b99; padding: 20px 0;">–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∫–ª—é—á–µ–π –≤ –ø—Ä–æ–¥–∞–∂–µ.</div>'; return; }
        keysData.forEach(k => { grid.innerHTML += `<div class="case-card"><div class="case-card-img"><img src="${k.image}" style="width:100%; height:100%;"></div><div class="case-card-title">${k.name}</div><div class="case-card-price">${k.price.toLocaleString('ru-RU')} ‚ÇΩ</div><button class="btn btn-warning" style="margin-top: 10px; padding: 8px;" onclick="buyKey('${k.id}', this)">–ö—É–ø–∏—Ç—å</button></div>`; });
    }

    function buyKey(keyId, btn) {
        if (btn.disabled) return; const keyItem = allItems[keyId];
        if (balance < keyItem.price) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∫–ª—é—á–∞!'); return; }
        if(confirm(`–ö—É–ø–∏—Ç—å ${keyItem.name} –∑–∞ ${keyItem.price.toLocaleString('ru-RU')} ‚ÇΩ?`)) {
            btn.disabled = true; let oldText = btn.innerText; btn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...'; balance -= keyItem.price; updateBalanceUI();
            inventory.push({ ...keyItem, invId: String(Date.now() + Math.random()) }); saveAllData();
            setTimeout(() => { btn.disabled = false; btn.innerText = oldText; }, 600);
        }
    }

    function openModal(id) { const m = document.getElementById(id); m.style.display = 'flex'; setTimeout(() => m.classList.add('show'), 10); }
    function closeModal(id) { const m = document.getElementById(id); m.classList.remove('show'); setTimeout(() => m.style.display = 'none', 300); }

    function changeCaseAmount(delta) {
        openAmount += delta; if(openAmount < 1) openAmount = 1; if(openAmount > 10) openAmount = 10; document.getElementById('caseAmount').innerText = openAmount;
        let finalPrice = getCasePrice(currentPreviewCase) * openAmount; let btnText = `–û—Ç–∫—Ä—ã—Ç—å ${openAmount} —à—Ç. –∑–∞ ${finalPrice.toLocaleString('ru-RU')} ‚ÇΩ`;
        if (currentPreviewCase.requiredKey) { const reqKeyItem = allItems[currentPreviewCase.requiredKey]; btnText += `<br><span style="font-size: 11px;">–¢—Ä–µ–±—É–µ—Ç—Å—è: ${reqKeyItem.name} (${openAmount} —à—Ç.)</span>`; }
        document.getElementById('viewCaseBtn').innerHTML = btnText;
    }

    function setCaseAmount(val) { openAmount = val; changeCaseAmount(0); }

    function openCasePreview(caseId) {
        currentPreviewCase = casesData.find(c => c.id === caseId); document.getElementById('viewCaseImg').src = currentPreviewCase.image || ''; openAmount = 1; document.getElementById('caseAmount').innerText = openAmount; document.getElementById('amountSelector').style.display = (caseId === 'agent_case') ? 'none' : 'flex'; changeCaseAmount(0); const dropsContainer = document.getElementById('viewCaseDrops'); dropsContainer.innerHTML = ''; const tierOrder = { '#ffea00': 0, '#eb4b4b': 1, '#54a0ff': 2, '#b0c3d9': 3 }; const dropsObjects = currentPreviewCase.drops.map(id => allItems[id]).filter(i => i !== undefined); dropsObjects.sort((a, b) => { let orderA = tierOrder[a.color] ?? 9; let orderB = tierOrder[b.color] ?? 9; if(orderA !== orderB) return orderA - orderB; return (b.price || 0) - (a.price || 0); });
        dropsObjects.forEach(item => {
            let displayContent = '';
            if (item.isSecret) displayContent = `<div style="font-size: 36px; margin: 10px 0; color: ${item.color};">‚ùì</div><div style="font-size: 11px; font-weight: bold; color: ${item.color}; margin-top:5px;">–°–µ–∫—Ä–µ—Ç–Ω—ã–π –¥—Ä–æ–ø</div>`;
            else if (item.type === 'money') displayContent = `<div style="font-size: 14px; font-weight: 800; margin: 18px 0; color: ${item.color};">${item.price.toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            else if (item.type === 'agent') { const displayIcon = item.image ? `<img src="${item.image}">` : `<div style="font-size:30px;">${item.icon}</div>`; displayContent = `${displayIcon}<div style="font-size: 9px; font-weight: bold; color: #fff; margin-top:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${item.name}</div><div style="font-size: 8px; color: ${item.color}; margin-top:2px;">–ë–∞—Ñ—Ñ –ê–≥–µ–Ω—Ç–∞</div>`; }
            else { const displayIcon = item.image ? `<img src="${item.image}">` : `<div style="font-size:30px;">${item.icon}</div>`; displayContent = `${displayIcon}<div style="font-size: 9px; font-weight: bold; color: #fff; margin-top:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;">${item.name}</div><div style="font-size: 9px; color: #8b8b99; margin-top:2px;">${item.price.toLocaleString('ru-RU')} ‚ÇΩ</div>`; }
            dropsContainer.innerHTML += `<div class="drop-item-card" style="border-top: 3px solid ${item.color};">${displayContent}</div>`;
        });
        switchPage('case-view', document.querySelectorAll('.nav-btn')[0]);
    }

    function confirmOpenCase() {
        if (isOpening) return; let finalPrice = getCasePrice(currentPreviewCase) * openAmount; if (balance < finalPrice) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ!'); return; }
        if (currentPreviewCase.id === 'agent_case' && getAnyAgent()) { alert('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∞–≥–µ–Ω—Ç! –£–≤–æ–ª—å—Ç–µ –µ–≥–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ, —á—Ç–æ–±—ã –Ω–∞–Ω—è—Ç—å –Ω–æ–≤–æ–≥–æ.'); return; }
        if (currentPreviewCase.requiredKey) { const reqKeyObj = allItems[currentPreviewCase.requiredKey]; let requiredKeys = inventory.filter(i => i.id === currentPreviewCase.requiredKey); if (requiredKeys.length < openAmount) { alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª—é—á–µ–π! –í–∞–º –Ω—É–∂–Ω–æ ${openAmount} —à—Ç. ${reqKeyObj.name}.`); return; } if (!confirm(`–û—Ç–∫—Ä—ã—Ç—å ${openAmount} –∫–µ–π—Å–æ–≤ –∑–∞ ${finalPrice.toLocaleString('ru-RU')} ‚ÇΩ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ${openAmount} –∫–ª—é—á–µ–π?`)) return; }
        
        isOpening = true; isStandardCase = true; isBonusMode = false; balance -= finalPrice;
        if (currentPreviewCase.requiredKey) { let keysRemoved = 0; inventory = inventory.filter(i => { if (i.id === currentPreviewCase.requiredKey && keysRemoved < openAmount) { keysRemoved++; return false; } return true; }); saveAllData(); }
        stats.opened += openAmount; updateBalanceUI(); document.getElementById('statOpened').innerText = stats.opened; saveAllData();
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById('page-roulette').classList.add('active'); const possibleDrops = currentPreviewCase.drops.map(id => allItems[id]).filter(item => item !== undefined);
        
        if (openAmount === 1) {
            document.getElementById('roulette').style.display = 'block'; document.getElementById('openingCaseName').innerText = `–û—Ç–∫—Ä—ã–≤–∞–µ–º ${currentPreviewCase.name}...`; initRoulette(possibleDrops);
            lastWonItem = JSON.parse(JSON.stringify(getWeightedRandomItem(possibleDrops, hasAgent('agent_zixxto')))); if (!lastWonItem.price) lastWonItem.price = 0; db.save('pending_claim', JSON.stringify(lastWonItem)); runRouletteAnimation(lastWonItem, () => { if (lastWonItem.isSecret) showResultModal('–î–ñ–ï–ö–ü–û–¢!'); else showResultModal('–í–∞—à –≤—ã–∏–≥—Ä—ã—à!'); });
        } else {
            document.getElementById('roulette').style.display = 'none'; document.getElementById('openingCaseName').innerHTML = `–û—Ç–∫—Ä—ã–≤–∞–µ–º ${openAmount}x ${currentPreviewCase.name}...<br><br><span style="font-size: 16px; color: #8b8b99;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ ‚öôÔ∏è</span>`; multiWonItems = [];
            for(let i=0; i<openAmount; i++) { let item = JSON.parse(JSON.stringify(getWeightedRandomItem(possibleDrops, hasAgent('agent_zixxto')))); if (!item.price) item.price = 0; multiWonItems.push(item); } db.save('pending_claim_multi', JSON.stringify(multiWonItems)); setTimeout(() => { document.getElementById('openingCaseName').innerText = "–û—Ç–∫—Ä—ã–≤–∞–µ–º..."; showMultiResultModal(openAmount); }, 1200);
        }
    }

    function initRoulette(dropList) {
        const container = document.getElementById('rouletteItems'); container.innerHTML = '';
        for (let i = 0; i < 70; i++) {
            let randomItem = dropList[Math.floor(Math.random() * dropList.length)]; if (!randomItem) continue;
            if (isStandardCase && Math.random() < 0.15 && currentPreviewCase.id !== 'agent_case') { let secItem = genericSecretItem; if (currentPreviewCase) { let caseSecrets = currentPreviewCase.drops.map(id => allItems[id]).filter(item => item && item.isSecret); if (caseSecrets.length > 0) secItem = caseSecrets[0]; } randomItem = secItem; }
            const div = document.createElement('div'); div.className = 'item'; div.style.borderBottom = `4px solid ${randomItem.color || '#fff'}`; div.style.background = `linear-gradient(to top, ${randomItem.color || '#fff'}22, transparent)`;
            if (randomItem.type === 'promo' || randomItem.type === 'nothing') div.innerHTML = `<div style="font-size: 40px;">${randomItem.icon}</div><div class="item-text" style="color:${randomItem.color}">${randomItem.name}</div>`;
            else if (randomItem.type === 'money') div.innerHTML = `<div style="font-size: 16px; font-weight: 800; color:${randomItem.color}">${(randomItem.price||0).toLocaleString('ru-RU')} ‚ÇΩ</div>`;
            else div.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; width:100%; height:100%;">${renderItemIcon(randomItem, true)}</div>`;
            container.appendChild(div);
        }
    }

    function runRouletteAnimation(winningItem, callback) {
        if (!winningItem) { callback(); return; } const winningIndex = 60; const rouletteItems = document.getElementById('rouletteItems'); const winDiv = rouletteItems.children[winningIndex];
        if (winDiv) { winDiv.style.borderBottom = `4px solid ${winningItem.color}`; winDiv.style.background = `linear-gradient(to top, ${winningItem.color}66, transparent)`; if (winningItem.type === 'promo' || winningItem.type === 'nothing') winDiv.innerHTML = `<div style="font-size: 40px;">${winningItem.icon}</div><div class="item-text" style="color:${winningItem.color}">${winningItem.name}</div>`; else if (winningItem.type === 'money') winDiv.innerHTML = `<div style="font-size: 16px; font-weight: 800; color:${winningItem.color}">${(winningItem.price||0).toLocaleString('ru-RU')} ‚ÇΩ</div>`; else winDiv.innerHTML = `<div style="filter: drop-shadow(0 0 15px ${winningItem.color}); display:flex; justify-content:center; align-items:center; width:100%; height:100%;">${renderItemIcon(winningItem, true)}</div>`; }
        if (isStandardCase && Math.random() < 0.15 && currentPreviewCase.id !== 'agent_case') { const offsetOptions = [-2, -1, 1, 2]; const secretIndex = winningIndex + offsetOptions[Math.floor(Math.random() * offsetOptions.length)]; if (rouletteItems.children[secretIndex]) { let secItem = genericSecretItem; if (currentPreviewCase) { let caseSecrets = currentPreviewCase.drops.map(id => allItems[id]).filter(item => item && item.isSecret); if (caseSecrets.length > 0) secItem = caseSecrets[0]; } const secretDiv = rouletteItems.children[secretIndex]; secretDiv.innerHTML = `<div style="display:flex; justify-content:center; align-items:center; width:100%; height:100%; filter: drop-shadow(0 0 15px ${secItem.color});">${renderItemIcon(secItem, true)}</div>`; secretDiv.style.borderBottom = `4px solid ${secItem.color}`; secretDiv.style.background = `linear-gradient(to top, ${secItem.color}44, transparent)`; } }
        const itemWidth = 140; const rouletteWidth = document.getElementById('roulette').offsetWidth; const finalOffset = (winningIndex * itemWidth) - (rouletteWidth / 2) + (itemWidth / 2) + (Math.floor(Math.random() * 80) - 40);
        rouletteItems.style.transition = 'none'; rouletteItems.style.transform = 'translateX(0)'; requestAnimationFrame(() => { requestAnimationFrame(() => { rouletteItems.style.transition = 'transform 5.5s cubic-bezier(0.1, 0.9, 0.1, 1)'; rouletteItems.style.transform = `translateX(-${finalOffset}px)`; }); });
        setTimeout(() => { if(winDiv) { winDiv.style.transition = 'transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; winDiv.style.transform = 'scale(1.15)'; winDiv.style.zIndex = '10'; } }, 5000); setTimeout(callback, 5700);
    }

    function showResultModal(title) {
        if (!lastWonItem) return; document.getElementById('resultTitle').innerText = title; document.getElementById('resultItemIcon').innerHTML = renderItemIcon(lastWonItem); document.getElementById('resultItemName').innerText = lastWonItem.name; document.getElementById('resultItemName').style.color = lastWonItem.color; document.getElementById('resultItemIcon').style.filter = `drop-shadow(0 0 40px ${lastWonItem.color})`;
        const infoBlock = document.getElementById('resultItemInfoBlock'); const itemsActions = document.getElementById('resultActionsContainer'); let priceNum = lastWonItem.price || 0;
        if (lastWonItem.type === 'promo') { infoBlock.innerHTML = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ <b>+5%</b> –∫ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—é!`; itemsActions.innerHTML = `<button class="btn btn-success" onclick="claimLuckyPromo(this)">–ó–∞–±—Ä–∞—Ç—å –≤ –±–æ—Ç–µ</button>`; } 
        else if (lastWonItem.type === 'nothing' || lastWonItem.type === 'fail') { infoBlock.innerHTML = lastWonItem.type === 'fail' ? `–ü—Ä–µ–¥–º–µ—Ç —Å–≥–æ—Ä–µ–ª.` : `–ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞!`; itemsActions.innerHTML = `<button class="btn btn-outline" onclick="finishOpening()">–ó–∞–∫—Ä—ã—Ç—å</button>`; } 
        else if (lastWonItem.type === 'money') { infoBlock.innerHTML = `–ó–∞—á–∏—Å–ª–µ–Ω–æ: <span style="color: #00b894; font-weight: bold;">${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</span>`; itemsActions.innerHTML = `<button class="btn btn-success" onclick="takeMoney(this)">üí∞ –ó–∞–±—Ä–∞—Ç—å –¥–µ–Ω—å–≥–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å</button>`; } 
        else if (lastWonItem.type === 'agent') { infoBlock.innerHTML = `<span style="color: #00b894; font-weight: bold;">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –±–∞—Ñ—Ñ—ã:</span><br><span style="font-size:12px; line-height: 1.5;">${lastWonItem.buffs.replace(/\n/g, '<br>')}</span>`; itemsActions.innerHTML = `<button class="btn btn-success" onclick="keepItem(this)">üíº –ù–∞–Ω—è—Ç—å –∞–≥–µ–Ω—Ç–∞</button>`; } 
        else { if (hasAgent('agent_perfecto')) priceNum = Math.floor(priceNum * 1.10); let buffText = hasAgent('agent_perfecto') ? `<br><span style="color:#00b894; font-size:11px;">(–°—Ä–∞–±–æ—Ç–∞–ª –±–∞—Ñ—Ñ –ü—Ä–æ–¥–∞–≤–µ—Ü +10%)</span>` : ''; infoBlock.innerHTML = `–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: <span style="color: #fdcb6e; font-weight: bold;">${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</span>${buffText}`; itemsActions.innerHTML = `<button class="btn btn-success" onclick="keepItem(this)">üéí –í –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button> <button class="btn btn-outline" onclick="sellFromModal(this)">üí∞ –ü—Ä–æ–¥–∞—Ç—å –∑–∞ ${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</button>`; }
        openModal('resultModal');
    }

    function showMultiResultModal(amount) {
        let totalValue = 0; multiWonItems.forEach(item => { if (item.type === 'money') totalValue += item.price; else { let sellPrice = item.price; if (hasAgent('agent_perfecto')) sellPrice = Math.floor(sellPrice * 1.10); totalValue += sellPrice; } });
        document.getElementById('multiCaseCount').innerText = amount; document.getElementById('multiTotalValue').innerText = totalValue.toLocaleString('ru-RU') + ' ‚ÇΩ'; const grid = document.getElementById('multiResultGrid'); grid.innerHTML = '';
        multiWonItems.forEach((item) => { let nameHtml = `<div style="color: ${item.color}; font-size: 10px; font-weight: bold; margin-top: 5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.name}</div>`; if(item.type === 'money') nameHtml = `<div style="color: ${item.color}; font-size: 11px; font-weight: bold; margin-top: 5px;">${item.price.toLocaleString('ru-RU')} ‚ÇΩ</div>`; grid.innerHTML += `<div style="background: #1f1f25; border-radius: 12px; padding: 10px 5px; text-align: center; border: 1px solid rgba(255,255,255,0.05); border-top: 3px solid ${item.color}; display:flex; flex-direction:column; justify-content:center;"><div style="height: 45px; display: flex; justify-content: center; align-items: center; font-size: 24px;">${renderItemIcon(item)}</div>${nameHtml}</div>`; });
        document.getElementById('multiActionsContainer').innerHTML = `<button class="btn btn-success" onclick="keepMultiItems(this)">üéí –ó–∞–±—Ä–∞—Ç—å –≤—Å—ë –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</button> <button class="btn btn-outline" onclick="sellMultiItems(this)">üí∞ –ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button>`; openModal('multiResultModal');
    }

    function keepMultiItems(btn) { if (btn) btn.disabled = true; if (multiWonItems.length === 0) return; let moneyAdded = 0; let itemsAdded = 0; multiWonItems.forEach(item => { if (item.type === 'money') moneyAdded += item.price; else if (item.type !== 'promo') { inventory.push({ ...item, invId: String(Date.now() + Math.random()) }); itemsAdded++; } }); multiWonItems = []; balance += moneyAdded; if(moneyAdded > 0) tg.showAlert(`–ü—Ä–µ–¥–º–µ—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!\n–ó–∞—á–∏—Å–ª–µ–Ω–æ –Ω–∞ –±–∞–ª–∞–Ω—Å: ${moneyAdded.toLocaleString('ru-RU')} ‚ÇΩ`); updateBalanceUI(); saveAllData(); db.save('pending_claim_multi', 'null'); finishOpening(); }
    function sellMultiItems(btn) { if (btn) btn.disabled = true; if (multiWonItems.length === 0) return; let totalAdded = 0; multiWonItems.forEach(item => { if (item.type === 'money') totalAdded += item.price; else if (item.type !== 'promo') { let sellPrice = item.price; if (hasAgent('agent_perfecto')) sellPrice = Math.floor(sellPrice * 1.10); totalAdded += sellPrice; } }); multiWonItems = []; balance += totalAdded; tg.showAlert(`–í—ã –ø—Ä–æ–¥–∞–ª–∏ –≤—Å—ë –∏ –ø–æ–ª—É—á–∏–ª–∏ ${totalAdded.toLocaleString('ru-RU')} ‚ÇΩ.`); updateBalanceUI(); db.save('pending_claim_multi', 'null'); finishOpening(); }
    function claimLuckyPromo(btn) { if (btn) btn.disabled = true; if (!lastWonItem) return; lastWonItem = null; tg.openTelegramLink('https://t.me/StockOGCasesBot?start=lucky'); finishOpening(); }
    function keepItem(btn) { if (btn) btn.disabled = true; if (!lastWonItem) return; let itemToKeep = lastWonItem; lastWonItem = null; inventory.push({ ...itemToKeep, invId: String(Date.now() + Math.random()) }); saveAllData(); db.save('pending_claim', 'null'); updateAgentStatus(); finishOpening(); }
    function sellFromModal(btn) { if (btn) btn.disabled = true; if (!lastWonItem) return; let priceNum = lastWonItem.price || 0; if (hasAgent('agent_perfecto') && lastWonItem.type !== 'money' && lastWonItem.type !== 'agent' && lastWonItem.type !== 'promo') priceNum = Math.floor(priceNum * 1.10); lastWonItem = null; balance += priceNum; updateBalanceUI(); db.save('pending_claim', 'null'); finishOpening(); }
    function takeMoney(btn) { if (btn) btn.disabled = true; if (!lastWonItem) return; const priceNum = lastWonItem.price || 0; lastWonItem = null; balance += priceNum; updateBalanceUI(); db.save('pending_claim', 'null'); finishOpening(); }
    function finishOpening() { db.save('pending_claim', 'null'); db.save('pending_claim_multi', 'null'); closeModal('resultModal'); closeModal('multiResultModal'); document.getElementById('page-roulette').classList.remove('active'); if(isBonusMode) { document.getElementById('page-bonus').classList.add('active'); updateBonusButton(); } else if(craftSelectedIds.length > 0 || upgMyItem) { document.getElementById('page-games').classList.add('active'); resetCrafting(); upgMyItem = null; updateUpgUI(); } else if(isStandardCase) { document.getElementById('page-case-view').classList.add('active'); } else { document.getElementById('page-cases').classList.add('active'); } isOpening = false; isBonusMode = false; isStandardCase = false; }

    function renderInventory() {
        const grid = document.getElementById('inventoryGrid'); document.getElementById('invCount').innerText = inventory.length; grid.innerHTML = '';
        if (inventory.length === 0) { grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8b8b99; padding: 40px 0;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>'; return; }
        const sortedInv = [...inventory].sort((a, b) => { if (a.type === 'agent' && b.type !== 'agent') return -1; if (a.type !== 'agent' && b.type === 'agent') return 1; return (b.price || 0) - (a.price || 0); });
        sortedInv.forEach(item => {
            const priceNum = item.price || 0;
            if (item.type === 'agent') { grid.innerHTML += `<div class="inv-item" style="border-top: 3px solid ${item.color}; background: rgba(108,92,231,0.1);"><div class="inv-item-img">${renderItemIcon(item)}</div><div class="inv-item-name" style="color: ${item.color}">${item.name}</div><div class="inv-item-price" style="white-space:normal; line-height:1.2;">–ë–∞—Ñ—Ñ –∞–∫—Ç–∏–≤–µ–Ω</div><div style="display: flex; gap: 5px; width: 100%; margin-top: 10px;"><button class="btn btn-outline" style="flex: 1; padding: 6px; font-size: 11px; border-color: #ff4757; color: #ff4757;" onclick="fireAgent('${item.invId}', '${item.name}')">–£–≤–æ–ª–∏—Ç—å</button></div></div>`; } 
            else { grid.innerHTML += `<div class="inv-item" style="border-top: 3px solid ${item.color};"><div class="inv-item-img">${renderItemIcon(item)}</div><div class="inv-item-name" style="color: ${item.color}">${item.name}</div><div class="inv-item-price">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</div><div style="display: flex; gap: 5px; width: 100%; margin-top: 10px;"><button class="btn btn-outline" style="flex: 1; padding: 6px; font-size: 11px; border-color: rgba(255,255,255,0.1); color: #fff;" onclick="sellSingleItem('${item.invId}', ${priceNum}, this)">–ü—Ä–æ–¥–∞—Ç—å</button><button class="btn btn-success" style="flex: 1; padding: 6px; font-size: 11px;" onclick="openWithdrawModal('${item.invId}')">–í—ã–≤–æ–¥</button></div></div>`; }
        });
    }

    function sellSingleItem(invId, basePrice, btnElement) { 
        if (btnElement) { if (btnElement.disabled) return; btnElement.disabled = true; btnElement.innerText = "‚è≥"; }
        const itemIdx = inventory.findIndex(item => String(item.invId) === String(invId)); if (itemIdx === -1) return; let finalPrice = basePrice; if (hasAgent('agent_perfecto')) finalPrice = Math.floor(finalPrice * 1.10); inventory.splice(itemIdx, 1); balance += finalPrice; updateBalanceUI(); saveAllData(); renderInventory(); 
    }
    
    function openWithdrawModal(invId) {
        if (!linkedRobloxAcc) { alert('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤—è–∂–∏—Ç–µ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç Roblox –≤ —Ä–∞–∑–¥–µ–ª–µ –ü—Ä–æ—Ñ–∏–ª—å!'); return; }
        const item = inventory.find(i => String(i.invId) === String(invId)); if (!item || (item.price || 0) < 150000) { alert("–í—ã–≤–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –æ—Ç 150 000 ‚ÇΩ!"); return; }
        currentWithdrawItemId = invId; document.getElementById('wdItemName').innerText = item.name; document.getElementById('wdTargetAcc').innerText = linkedRobloxAcc; openModal('withdrawModal');
    }

    function confirmWithdraw() {
        const btn = document.getElementById('wdSubmitBtn'); btn.innerText = '–û—Ç–ø—Ä–∞–≤–∫–∞...'; btn.disabled = true;
        setTimeout(() => { const itemIdx = inventory.findIndex(i => String(i.invId) === String(currentWithdrawItemId)); if (itemIdx === -1) return; const item = inventory[itemIdx]; inventory.splice(itemIdx, 1); saveAllData(); renderInventory(); closeModal('withdrawModal'); const payloadStr = `${item.id}||${item.price || 0}||${linkedRobloxAcc}`; const payload = btoa(unescape(encodeURIComponent(payloadStr))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); tg.openTelegramLink(`https://t.me/StockOGCasesBot?start=wd_${payload}`); btn.innerText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–≤–æ–¥'; btn.disabled = false; }, 300);
    }

    function applyPromo(btn) { const code = document.getElementById('promoInput').value.trim(); if (!code) { alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥!"); return; } btn.disabled = true; btn.innerText = '...'; tg.openTelegramLink(`https://t.me/StockOGCasesBot?start=promo_${code}`); setTimeout(() => { document.getElementById('promoInput').value = ''; btn.disabled = false; btn.innerText = '–û–ö'; }, 2000); }
    function copyRefLink() { navigator.clipboard.writeText(document.getElementById('refLink').innerText).then(() => { alert('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); }); }

    function renderCraftInventory() {
        const grid = document.getElementById('craftInventoryGrid'); grid.innerHTML = ''; const standardInv = inventory.filter(i => !i.isSecret && i.type !== 'money' && i.type !== 'key' && i.type !== 'agent');
        if (standardInv.length < 3) { grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8b8b99; padding: 20px 0;">–î–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –æ–±—ã—á–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞</div>'; return; }
        standardInv.forEach(item => { const isSelected = craftSelectedIds.includes(String(item.invId)); grid.innerHTML += `<div class="inv-item ${isSelected ? 'selected' : ''}" style="border-top: 3px solid ${item.color};" onclick="toggleCraftItem('${item.invId}')"><div class="inv-item-img">${renderItemIcon(item)}</div><div class="inv-item-name">${item.name}</div></div>`; }); updateCraftSlots();
    }
    function toggleCraftItem(invId) { if (craftSelectedIds.includes(String(invId))) craftSelectedIds = craftSelectedIds.filter(id => id !== String(invId)); else if (craftSelectedIds.length < 3) craftSelectedIds.push(String(invId)); renderCraftInventory(); }
    function updateCraftSlots() { for(let i=0; i<3; i++) { const slot = document.getElementById(`slot-${i}`); if (craftSelectedIds[i]) { const item = inventory.find(x => String(x.invId) === String(craftSelectedIds[i])); slot.innerHTML = renderItemIcon(item); slot.classList.add('filled'); } else { slot.innerHTML = ''; slot.classList.remove('filled'); } } const btn = document.getElementById('btnCraft'); if (craftSelectedIds.length === 3) { btn.style.opacity = '1'; btn.style.cursor = 'pointer'; } else { btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; } }
    
    function executeCraft() {
        if (craftSelectedIds.length < 3 || isOpening) return; isOpening = true; isStandardCase = false; stats.crafts += 1; document.getElementById('statCrafts').innerText = stats.crafts; saveAllData();
        inventory = inventory.filter(item => !craftSelectedIds.includes(String(item.invId))); saveAllData(); document.getElementById('page-games').classList.remove('active'); document.getElementById('page-roulette').classList.add('active'); document.getElementById('openingCaseName').innerText = "–ö–æ–Ω—Ç—Ä–∞–∫—Ç..."; document.getElementById('roulette').style.display = 'block';
        let possibleDrops = Object.values(allItems).filter(i => !i.isSecret && i.type === 'item' && i.type !== 'agent');
        if (hasAgent('agent_vovan') || hasAgent('agent_perfecto')) { possibleDrops = possibleDrops.map(item => { let w = item.weight || 1; if ((item.price || 0) > 80000) w *= 3; return { ...item, weight: w }; }); }
        initRoulette(possibleDrops); const baseWonItem = getWeightedRandomItem(possibleDrops); lastWonItem = JSON.parse(JSON.stringify(baseWonItem)); if (!lastWonItem.price) lastWonItem.price = 0; db.save('pending_claim', JSON.stringify(lastWonItem)); runRouletteAnimation(lastWonItem, () => { showResultModal('–ö–æ–Ω—Ç—Ä–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω!'); craftSelectedIds = []; });
    }
    function resetCrafting() { craftSelectedIds = []; if(document.getElementById('tab-contract').classList.contains('active')) renderCraftInventory(); }

    function openUpgMyModal() { const grid = document.getElementById('upgMyGrid'); grid.innerHTML = ''; const standardInv = inventory.filter(i => !i.isSecret && i.type !== 'money' && i.type !== 'key' && i.type !== 'agent'); if (standardInv.length === 0) { grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #8b8b99;">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>'; } else { standardInv.forEach(item => { const priceNum = item.price || 0; grid.innerHTML += `<div class="inv-item" style="border-top: 3px solid ${item.color};" onclick="selectUpgMy('${item.invId}')"><div class="inv-item-img">${renderItemIcon(item)}</div><div class="inv-item-name">${item.name}</div><div class="inv-item-price">${priceNum.toLocaleString('ru-RU')} ‚ÇΩ</div></div>`; }); } openModal('upgMyModal'); }
    function selectUpgMy(invId) { upgMyItem = inventory.find(i => String(i.invId) === String(invId)); closeModal('upgMyModal'); updateUpgUI(); }
    function openUpgTargetModal() { const grid = document.getElementById('upgTargetGrid'); grid.innerHTML = ''; const targetPool = Object.values(allItems).filter(d => d.type === 'item' && !d.isSecret && (d.price || 0) > 10000 && d.type !== 'agent'); targetPool.sort((a,b) => (a.price || 0) - (b.price || 0)).forEach(item => { let p = item.price || 0; grid.innerHTML += `<div class="inv-item" style="border-top: 3px solid ${item.color};" onclick="selectUpgTarget('${item.id}')"><div class="inv-item-img">${renderItemIcon(item)}</div><div class="inv-item-name">${item.name}</div><div class="inv-item-price">${p.toLocaleString('ru-RU')} ‚ÇΩ</div></div>`; }); openModal('upgTargetModal'); }
    function selectUpgTarget(id) { upgTargetItem = allItems[id]; closeModal('upgTargetModal'); updateUpgUI(); }
    function updateUpgUI() { const mySlot = document.getElementById('upg-my-slot'); if (upgMyItem) { mySlot.innerHTML = renderItemIcon(upgMyItem); mySlot.classList.add('filled'); } else { mySlot.innerHTML = '<span style="font-size:12px; color:#8b8b99;">–í–∞—à<br>–ø—Ä–µ–¥–º–µ—Ç</span>'; mySlot.classList.remove('filled'); } const targetSlot = document.getElementById('upg-target-slot'); if (upgTargetItem) { targetSlot.innerHTML = renderItemIcon(upgTargetItem); targetSlot.classList.add('filled'); } else { targetSlot.innerHTML = '<span style="font-size:12px; color:#8b8b99;">–ñ–µ–ª–∞–µ–º—ã–π<br>–ø—Ä–µ–¥–º–µ—Ç</span>'; targetSlot.classList.remove('filled'); } let chance = 0; if (upgMyItem && upgTargetItem) { let trgP = upgTargetItem.price || 1; let myP = upgMyItem.price || 0; let agentUpgBonus = 0; if (hasAgent('agent_vovan')) agentUpgBonus = 6; else if (hasAgent('agent_cheba') || hasAgent('agent_funky') || hasAgent('agent_pechen')) agentUpgBonus = 5; chance = Math.min((myP / trgP) * 100 * 0.9 + agentUpgBonus, 95); } document.getElementById('upg-chance').innerText = `–®–∞–Ω—Å: ${chance.toFixed(1)}%`; const btn = document.getElementById('btnUpgrade'); if (upgMyItem && upgTargetItem) { btn.style.opacity = '1'; btn.style.cursor = 'pointer'; } else { btn.style.opacity = '0.5'; btn.style.cursor = 'not-allowed'; } }
    
    function executeUpgrade() {
        if (!upgMyItem || !upgTargetItem || isOpening) return; isOpening = true; isStandardCase = false; let trgP = upgTargetItem.price || 1; let myP = upgMyItem.price || 0; let agentUpgBonus = 0; if (hasAgent('agent_vovan')) agentUpgBonus = 6; else if (hasAgent('agent_cheba') || hasAgent('agent_funky') || hasAgent('agent_pechen')) agentUpgBonus = 5; let chance = Math.min((myP / trgP) * 100 * 0.9 + agentUpgBonus, 95); let roll = Math.random() * 100; let isWin = roll <= chance; inventory = inventory.filter(i => String(i.invId) !== String(upgMyItem.invId)); saveAllData(); document.getElementById('page-games').classList.remove('active'); document.getElementById('page-roulette').classList.add('active'); document.getElementById('openingCaseName').innerText = "–ê–ø–≥—Ä–µ–π–¥..."; document.getElementById('roulette').style.display = 'block'; const r = document.getElementById('rouletteItems'); r.innerHTML = ''; for (let i = 0; i < 70; i++) { let item = (Math.random() < 0.5) ? upgTargetItem : { icon: '‚ùå', color: '#8b8b99' }; const div = document.createElement('div'); div.className = 'item'; div.style.borderBottom = `4px solid ${item.color}`; div.innerHTML = `<div>${renderItemIcon(item)}</div>`; r.appendChild(div); } if (isWin) { lastWonItem = JSON.parse(JSON.stringify(upgTargetItem)); } else { lastWonItem = { id: 'fail', icon: '‚ùå', name: '–ü–†–û–í–ê–õ', color: '#8b8b99', price: 0, type: 'fail' }; } if (!lastWonItem.price) lastWonItem.price = 0; db.save('pending_claim', JSON.stringify(lastWonItem)); runRouletteAnimation(lastWonItem, () => { if (isWin) { showResultModal('–ê–ø–≥—Ä–µ–π–¥ —É—Å–ø–µ—à–µ–Ω!'); } else { showResultModal('–ü—Ä–æ–≤–∞–ª...'); } upgMyItem = null; upgTargetItem = null; }); 
    }
</script>
</body>
</html>
